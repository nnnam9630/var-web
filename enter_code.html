<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghép đôi Camera VAR</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tải PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- Tải TensorFlow.js và các model AI -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@latest/dist/blazeface.min.js"></script>

    <!-- Tải Font Be Vietnam Pro -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    
    <!-- SỬA LỖI: Quay về Material ICONS Round (bản cũ) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* SỬA LỖI: Nền chính */
        html {
            background-image: url('https://images.ctfassets.net/seegk6e7ypwi/60TvXEVrvciW5CvsnqQmYZ/599e887296658b7297caa4400b27196a/fc-26-community-background-image.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        body {
            font-family: "Be Vietnam Pro", sans-serif;
            /* SỬA LỖI: Bỏ bg-gray-900 */
            background: transparent; 
            color: white;
        }
        
        /* SỬA LỖI: Panel nội dung đen 50% */
        .content-panel {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* 6 ô nhập mã */
        .code-input-container {
            display: flex;
            gap: 0.5rem; 
        }
        .code-input {
            width: 2em;
            height: 2.5em;
            font-size: 1.25rem; /* 20px */
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #4B5563; /* border-gray-600 */
            /* SỬA LỖI: Nền trong suốt hơn */
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            caret-color: #3B82F6; /* blue-500 */
        }
        .code-input:focus {
            outline: none;
            border-color: #3B82F6; /* border-blue-500 */
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5), 0 0 0 4px #3B82F6; /* Ring */
        }
        
        /* Canvas cho AI detection */
        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Cho phép click xuyên qua */
        }
        
        .material-icons-round {
            font-family: 'Material Icons Round';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: 'liga';
            user-select: none;
        }
        .btn-icon {
            font-size: 1.25rem; /* 20px */
        }
        
        /* Nút bấm (dùng cho Bật Detect và Kết nối) */
        .glass-button {
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease-in-out;
            color: white; 
            border-radius: 0.5rem; /* rounded-lg */
        }
        .glass-button:hover {
            background-color: rgba(20, 20, 20, 0.7); 
        }
        .glass-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .glass-button.danger { background-color: rgba(220, 38, 38, 0.5); }
        .glass-button.danger:hover { background-color: rgba(220, 38, 38, 0.7); }
        .glass-button.info { background-color: rgba(59, 130, 246, 0.5); }
        .glass-button.info:hover { background-color: rgba(59, 130, 246, 0.7); }
        .glass-button.purple { background-color: rgba(139, 92, 246, 0.5); }
        .glass-button.purple:hover { background-color: rgba(139, 92, 246, 0.7); }
        
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl mx-auto">
        <!-- SỬA LỖI: Thêm class .content-panel -->
        <div class="content-panel p-6">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Ghép đôi Camera VAR</h1>

            <div id="errorMessage" class="hidden bg-red-800 text-white p-4 rounded-lg mb-4">
                <!-- Lỗi sẽ được điền vào đây -->
            </div>
            <div id="statusMessage" class="hidden bg-blue-800 text-white p-4 rounded-lg mb-4">
                <!-- Trạng thái sẽ được điền vào đây -->
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                
                <!-- Cột Trái: Camera Preview -->
                <div class="lg:w-2/3 w-full">
                    <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden shadow-lg">
                        <video id="localPreview" class="w-full h-full object-cover" autoplay muted playsinline></video>
                        <canvas id="detectionCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                        
                        <div id="statusIndicator" class="absolute top-3 left-3 hidden items-center gap-2 bg-black/50 text-white px-3 py-1 rounded-full text-sm">
                            <span id="statusIcon" class="material-icons-round text-yellow-400 text-base animate-spin">autorenew</span>
                            <span id="statusText">Đang kết nối...</span>
                        </div>
                    </div>
                    <button id="btnToggleDetection" class="mt-4 w-full glass-button purple text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2" disabled>
                        <span id="detectIcon" class="material-icons-round btn-icon">auto_awesome</span>
                        <span id="btnDetectionText">Bật Detect</span>
                    </button>
                </div>
                
                <!-- Cột Phải: Nhập mã -->
                <div class="lg:w-1/3 w-full flex flex-col justify-center">
                    <!-- SỬA LỖI: Thêm class .content-panel -->
                    <div class="content-panel p-6">
                        <label for="code-0" class="block text-sm font-medium text-gray-300 mb-2">Nhập mã ghép đôi (6 chữ cái):</label>
                        <div class="code-input-container mb-4 justify-center">
                            <!-- SỬA LỖI: Khôi phục 6 ô input -->
                            <input type="text" maxlength="1" id="code-0" class="code-input uppercase" data-index="0">
                            <input type="text" maxlength="1" id="code-1" class="code-input uppercase" data-index="1">
                            <input type="text" maxlength="1" id="code-2" class="code-input uppercase" data-index="2">
                            <input type="text" maxlength="1" id="code-3" class="code-input uppercase" data-index="3">
                            <input type="text" maxlength="1" id="code-4" class="code-input uppercase" data-index="4">
                            <input type="text" maxlength="1" id="code-5" class="code-input uppercase" data-index="5">
                        </div>

                        <button id="btnConnect" class="w-full glass-button info text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50" disabled>
                            <span id="btnConnectText">Đang tải...</span>
                        </button>
                    </div>
                </div>
            </div> <!-- Kết thúc flex 2 cột -->
            
        </div>
    </div>

    <script type="module">
        let peer = null;
        let localStream = null;
        
        // Biến AI
        let faceModel = null;
        let objectModel = null;
        let isDetectionRunning = false; // Tắt theo mặc định
        let detectionInterval = null;
        
        const localPreview = document.getElementById('localPreview');
        const detectionCanvas = document.getElementById('detectionCanvas');
        const detCtx = detectionCanvas.getContext('2d');
        
        const btnToggleDetection = document.getElementById('btnToggleDetection');
        const btnDetectionText = document.getElementById('btnDetectionText');
        const detectIcon = document.getElementById('detectIcon');
        
        const btnConnect = document.getElementById('btnConnect');
        const btnConnectText = document.getElementById('btnConnectText');
        
        const statusIndicator = document.getElementById('statusIndicator');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        
        const errorMessage = document.getElementById('errorMessage');
        const statusMessage = document.getElementById('statusMessage');
        
        const codeInputs = [...document.querySelectorAll('.code-input')];

        /**
         * Phát video an toàn
         */
        async function playVideoSafe(videoElement) {
            if (!videoElement) return;
            videoElement.muted = true;
            try {
                await videoElement.play();
            } catch (error) {
                if (error.name !== 'AbortError' && !error.message.includes('interrupted')) {
                    console.error("Lỗi phát video preview:", error);
                }
            }
        }
        
        function showError(message) {
            statusMessage.classList.add('hidden');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function showStatus(message) {
            errorMessage.classList.add('hidden');
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
        }

        function showIndicator(message, icon = 'autorenew', spin = true) {
            statusText.textContent = message;
            statusIcon.textContent = icon;
            if (spin) {
                statusIcon.classList.add('animate-spin');
            } else {
                statusIcon.classList.remove('animate-spin');
            }
            statusIndicator.classList.remove('hidden');
            statusIndicator.classList.add('flex');
        }
        
        function hideIndicator() {
            statusIndicator.classList.add('hidden');
            statusIndicator.classList.remove('flex');
        }

        /**
         * 1. Khởi tạo PeerJS
         */
        function initializePeer() {
             try {
                peer = new Peer({ debug: 2 }); 

                peer.on('open', (id) => {
                    console.log('PeerJS đã sẵn sàng. ID của tôi là:', id);
                    btnConnectText.textContent = 'Kết nối';
                    btnConnect.disabled = false; 
                });

                peer.on('error', (err) => {
                    console.error('Lỗi PeerJS:', err);
                    showError(`Lỗi kết nối: ${err.message}. Thử tải lại trang.`);
                    btnConnectText.textContent = 'Lỗi';
                    btnConnect.disabled = true;
                });
            } catch (e) {
                 console.error("Không thể tải PeerJS. Kiểm tra kết nối.", e);
                 showError("Không thể tải thư viện kết nối. Vui lòng tải lại trang.");
            }
        }

        /**
         * 2. Khởi tạo Camera
         */
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        aspectRatio: 16/9,
                        width: { ideal: 1280 },
                        facingMode: "environment" 
                    },
                    audio: false 
                };

                try {
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (e1) {
                    console.warn("Không thể lấy camera 16:9, thử lại với cài đặt mặc định...", e1.name);
                    const fallbackConstraints = {
                        video: {
                            width: { ideal: 1280 },
                            facingMode: "environment"
                        },
                        audio: false
                    };
                    try {
                         localStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    } catch (e2) {
                        console.warn("Thất bại lần 2, thử với camera trước...", e2.name);
                         localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    }
                }
                
                localPreview.srcObject = localStream;
                await playVideoSafe(localPreview);
                
                if (detectionInterval) clearInterval(detectionInterval);
                detectionInterval = setInterval(runDetection, 100);

            } catch (err) {
                console.error("Lỗi bật camera:", err);
                if (err.name === "NotAllowedError") {
                    showError("Bạn đã từ chối quyền truy cập camera.");
                } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                    showError("Không tìm thấy camera trên thiết bị này.");
                } else {
                    showError("Không thể bật camera. Vui lòng thử lại.");
                }
            }
        }
        
        /**
         * 3. Khởi tạo AI Models
         */
        async function loadModels() {
            try {
                if (!window.tf || !window.blazeface || !window.cocoSsd) {
                    showError("Lỗi tải thư viện AI.");
                    return;
                }
                showStatus('Đang tải model AI (phát hiện bóng)...');
                await tf.setBackend('webgl');
                objectModel = await cocoSsd.load();
                showStatus('Đang tải model AI (phát hiện khuôn mặt)...');
                faceModel = await blazeface.load();
                console.log("Đã tải xong 2 model AI.");
                showStatus('AI đã sẵn sàng. Chờ kết nối...');
                btnToggleDetection.disabled = false;
            } catch (err) {
                console.error("Lỗi tải model AI:", err);
                showError("Lỗi tải model AI. Tính năng phát hiện có thể không hoạt động.");
            }
        }
        
        /**
         * 4. Chạy AI Detection
         */
        async function runDetection() {
            if (!isDetectionRunning || (!faceModel && !objectModel) || !detCtx || !localPreview) {
                 if (detCtx) detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                return;
            }
                
            const sourceElement = localPreview;
            if (sourceElement.paused || sourceElement.ended || sourceElement.readyState < 2) {
                detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                return;
            }

            const p1 = faceModel ? faceModel.estimateFaces(sourceElement, false) : Promise.resolve([]);
            const p2 = objectModel ? objectModel.detect(sourceElement) : Promise.resolve([]);
            const [facePredictions, objectPredictions] = await Promise.all([p1, p2]);

            const videoRatio = sourceElement.videoWidth / sourceElement.videoHeight;
            const canvasRatio = detCtx.canvas.clientWidth / detCtx.canvas.clientHeight;
            let scale = 1, offsetX = 0, offsetY = 0;

            if (videoRatio > canvasRatio) { 
                scale = detCtx.canvas.clientHeight / sourceElement.videoHeight;
                offsetX = (detCtx.canvas.clientWidth - sourceElement.videoWidth * scale) / 2;
            } else { 
                scale = detCtx.canvas.clientWidth / sourceElement.videoWidth;
                offsetY = (detCtx.canvas.clientHeight - sourceElement.videoHeight * scale) / 2;
            }
            
            detectionCanvas.width = detCtx.canvas.clientWidth;
            detectionCanvas.height = detCtx.canvas.clientHeight;

            detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            detCtx.font = '16px "Be Vietnam Pro", sans-serif';
            detCtx.textBaseline = 'top';
            
            facePredictions.forEach(pred => {
                const [startX, startY] = pred.topLeft;
                const [endX, endY] = pred.bottomRight;
                const [width, height] = [endX - startX, endY - startY];
                const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                detCtx.strokeStyle = '#32CD32'; 
                detCtx.lineWidth = 2;
                detCtx.strokeRect(x, y, w, h);
                detCtx.fillStyle = '#32CD32';
                detCtx.fillText('Face', x, y > 18 ? y - 18 : y + h + 4);
            });
            
            objectPredictions.forEach(pred => {
                if (pred.class === 'sports ball') {
                    const [startX, startY, width, height] = pred.bbox;
                    const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                    detCtx.strokeStyle = '#FFD700'; 
                    detCtx.lineWidth = 2;
                    detCtx.strokeRect(x, y, w, h);
                    detCtx.fillStyle = '#FFD700';
                    const label = `Ball (${Math.round(pred.score * 100)}%)`;
                    detCtx.fillText(label, x, y > 18 ? y - 18 : y + h + 4);
                }
            });
        }
        
        /**
         * 5. Xử lý logic nhập mã
         */
        codeInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const value = input.value.toUpperCase();
                input.value = value;
                const index = parseInt(input.dataset.index, 10);
                if (value && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                const index = parseInt(input.dataset.index, 10);
                if (e.key === 'Backspace' && !input.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text').toUpperCase();
                if (pasteData.length === codeInputs.length) {
                    codeInputs.forEach((input, index) => {
                        input.value = pasteData[index] || '';
                    });
                    codeInputs[codeInputs.length - 1].focus();
                }
            });
        });

        /**
         * 6. Xử lý nút Kết nối và Bật/Tắt Detect
         */
        if (btnToggleDetection) {
            btnToggleDetection.addEventListener('click', () => {
                isDetectionRunning = !isDetectionRunning; 
                if (isDetectionRunning) {
                    btnDetectionText.textContent = 'Tắt Detect';
                    btnToggleDetection.classList.add('danger');
                    btnToggleDetection.classList.remove('purple');
                    // SỬA LỖI: Quay về logic cũ
                    detectIcon.textContent = 'disabled_by_default'; 
                } else {
                    btnDetectionText.textContent = 'Bật Detect';
                    btnToggleDetection.classList.remove('danger');
                    btnToggleDetection.classList.add('purple');
                    detectIcon.textContent = 'auto_awesome';
                    if (detCtx) detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                }
            });
        }
         
        if (btnConnect) {
            btnConnect.addEventListener('click', () => {
                if (!peer) {
                    showError("Kết nối PeerJS chưa sẵn sàng. Vui lòng chờ.");
                    return;
                }
                if (!localStream) {
                    showError("Camera chưa sẵn sàng. Vui lòng cấp quyền.");
                    return;
                }
                
                const code = codeInputs.map(input => input.value).join('').toUpperCase();
                
                if (code.length !== 6) {
                    showError("Mã ghép đôi phải đủ 6 chữ cái.");
                    return;
                }

                showStatus(`Đang kết nối đến ${code}...`);
                showIndicator(`Đang kết nối ${code}...`, 'autorenew', true);
                btnConnect.disabled = true;
                btnConnectText.textContent = 'Đang kết nối...';
                
                const dataConn = peer.connect(code, { reliable: true });

                dataConn.on('open', () => {
                    console.log(`Đã mở DataConnection đến ${code}`);
                    showStatus('Đã kết nối data. Đang chờ chấp nhận...');
                    showIndicator('Chờ chấp nhận...', 'pending', false);
                    
                    dataConn.on('data', (data) => {
                        if (data === 'accepted') {
                            console.log("Admin đã chấp nhận. Bắt đầu gọi video...");
                            showStatus('Được chấp nhận! Đang truyền video...');
                            showIndicator('Đang truyền video', 'sensors', true);
                            
                            const mediaCall = peer.call(code, localStream);
                            
                            mediaCall.on('close', () => {
                                showStatus('Kết nối video đã đóng. Sẵn sàng kết nối mới.');
                                hideIndicator();
                                btnConnect.disabled = false;
                                btnConnectText.textContent = 'Kết nối';
                                btnToggleDetection.classList.remove('hidden'); 
                            });
                            
                            mediaCall.on('error', (err) => {
                                console.error("Lỗi MediaCall:", err);
                                showError(`Lỗi truyền video: ${err.message}`);
                                hideIndicator();
                            });
                            
                            isDetectionRunning = false;
                            if (detectionInterval) clearInterval(detectionInterval);
                            detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                            btnToggleDetection.classList.add('hidden'); 
                        }
                    });
                });

                dataConn.on('error', (err) => {
                    console.error("Lỗi DataConnection:", err);
                    showError(`Lỗi kết nối data: ${err.message}`);
                    hideIndicator();
                    btnConnect.disabled = false;
                    btnConnectText.textContent = 'Kết nối';
                });
                
                dataConn.on('close', () => {
                    console.log("DataConnection đã đóng.");
                    if (statusText.textContent.includes('Đang truyền video') === false) {
                        showStatus('Kết nối bị từ chối hoặc đã đóng.');
                        hideIndicator();
                        btnConnect.disabled = false;
                        btnConnectText.textContent = 'Kết nối';
                    }
                });
            });
        }
        
        // --- CHẠY KHỞI TẠO ---
        if (typeof Peer === 'undefined') {
            showError('Lỗi: Không thể tải thư viện PeerJS. Vui lòng kiểm tra kết nối mạng và thử tải lại trang.');
        } else {
            initializePeer();
            startCamera(); 
            loadModels();  
        }
    </script>
</body>
</html>
