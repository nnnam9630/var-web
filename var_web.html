<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh m√¥ ph·ªèng VAR</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- T·∫£i PeerJS (thay th·∫ø Firebase) -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- T·∫£i TensorFlow.js v√† c√°c model AI -->
    <!-- 1. Core TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <!-- 2. Model ph√°t hi·ªán v·∫≠t th·ªÉ (tr√°i b√≥ng) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <!-- 3. Model ph√°t hi·ªán khu√¥n m·∫∑t -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@latest/dist/blazeface.min.js"></script>
    <link rel="stylesheet" href="premier-league-vn.css">


    <style>
        body {
            font-family: 'Premier League VN', sans-serif;
            overflow: hidden;
        }
        /* CSS t√πy ch·ªânh cho canvas */
        #reviewCanvas {
            cursor: crosshair;
            touch-action: none;
        }
        .decision-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        .layout-btn.active {
            opacity: 1;
            background-color: #2563eb; /* bg-blue-600 */
        }
        .layout-btn:not(.active) {
            opacity: 0.7;
            background-color: #4b5563; /* bg-gray-600 */
        }
        /* ·∫®n dropdown menu (cho n√∫t 3 ch·∫•m) */
        .camera-menu {
            display: none;
        }
        /* Hi·ªÉn th·ªã dropdown khi hover ho·∫∑c focus-within group */
        .group:hover .camera-menu,
        .group:focus-within .camera-menu {
            display: block;
        }
        
        /* ƒê·∫£m b·∫£o video trong g√≥c m√°y quay l√† 16:9 */
        .camera-angle-video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* S·ª¨ D·ª§NG COVER */
        }
        /* Wrapper cho thumbnail 16:9 */
        .camera-angle-wrapper {
            aspect-ratio: 16 / 9;
            background-color: #000; /* N·ªÅn ƒëen cho t·ª∑ l·ªá */
        }
        
        /* S·ª¨A L·ªñI: C·∫≠p nh·∫≠t CSS cho M√†n h√¨nh ch√≠nh (img v√† video) */
        #mainVideoFeedImage, #mainVideoFeedVideo {
             object-fit: cover; /* S·ª¨ D·ª§NG COVER (thay v√¨ contain) */
        }

        /* Canvas cho AI detection */
        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Cho ph√©p click xuy√™n qua */
        }
    </style>
</head>
<!--
  B·ªë c·ª•c Sticky Footer b·∫±ng Flexbox (h-screen):
  1. body: h-screen, flex, flex-col -> Chi·∫øm CH√çNH X√ÅC to√†n m√†n h√¨nh.
  2. div.container: flex-grow, flex, flex-col, overflow-y-auto -> Co gi√£n l·∫•p ƒë·∫ßy V√Ä T·ª∞ CU·ªòN B√äN TRONG.
  3. main: flex-grow -> Main co gi√£n l·∫•p ƒë·∫ßy container. (S·ª¨A L·ªñI: Chuy·ªÉn main v·ªÅ flex-grow)
  4. footer: flex-shrink-0 -> Footer kh√¥ng b·ªã co l·∫°i.
-->
<body class="bg-gray-900 text-white font-sans antialiased h-screen flex flex-col">

    <!-- Container ch√≠nh (N·ªôi dung) -->
    <!-- S·ª¨A L·ªñI: Th√™m flex-grow, flex-col V√Ä overflow-y-auto -->
    <div class="container mx-auto p-4 max-w-7xl flex-grow flex flex-col overflow-y-auto">
        
        <!--
          B·ªë c·ª•c Flex cho 2 c·ªôt ch√≠nh
          S·ª¨A L·ªñI: Th√™m flex-grow ƒë·ªÉ main l·∫•p ƒë·∫ßy container
        -->
        <main class="flex flex-col lg:flex-row gap-6 flex-grow">
            
            <!-- C·ªôt b√™n tr√°i: M√†n h√¨nh ch√≠nh & B·∫£ng ƒëi·ªÅu khi·ªÉn -->
            <div class="lg:w-2/3 flex flex-col gap-5">
                <!-- Th√™m flex-grow v√† flex flex-col ƒë·ªÉ ph·∫ßn n√†y l·∫•p ƒë·∫ßy c·ªôt tr√°i -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-5 flex-grow flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">M√†n h√¨nh ch√≠nh</h2>
                    
                    <!-- M√†n h√¨nh xem l·∫°i (H√¨nh ·∫£nh & Canvas) -->
                    <div id="reviewScreen" class="relative w-full aspect-video bg-black rounded-md overflow-hidden">
                        
                        <!-- Ch·∫ø ƒë·ªô xem ƒë∆°n -->
                        <div id="singleView" class="w-full h-full">
                            <!-- H√¨nh ·∫£nh s·ª± c·ªë (placeholder) -->
                            <img id="mainVideoFeedImage" 
                                 src="https://placehold.co/1920x1080/22c55e/ffffff?text=S√¢n+c·ªè" 
                                 alt="Video feed image" 
                                 class="w-full h-full object-cover"> <!-- S·ª¨A: object-cover -->
                                 
                            <!-- Video (d√πng cho WebRTC) -->
                            <video id="mainVideoFeedVideo"
                                   alt="Video feed video"
                                   class="w-full h-full object-cover hidden" <!-- S·ª¨A: object-cover -->
                                   autoplay muted playsinline></video>
                            
                            <!-- Canvas ƒë·ªÉ v·∫Ω v·∫°ch -->
                            <canvas id="reviewCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                            <!-- Canvas cho AI Detection -->
                            <canvas id="detectionCanvas" class="absolute top-0 left-0"></canvas>
                        </div>
                        
                        <!-- Ch·∫ø ƒë·ªô xem l∆∞·ªõi -->
                        <div id="gridView" class="w-full h-full grid grid-cols-2 gap-1 hidden">
                            <!-- C√°c √¥ l∆∞·ªõi s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                        </div>
                    </div>

                    <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn -->
                    <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn s·∫Ω n·∫±m t·ª± nhi√™n b√™n d∆∞·ªõi m√†n h√¨nh -->
                    <div class="mt-4 p-4 bg-gray-700 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3">B·∫£ng ƒëi·ªÅu khi·ªÉn</h3>
                        
                        <!-- H√†ng 1 (G·ªòP): ƒêi·ªÅu khi·ªÉn ch√≠nh & C√¥ng c·ª• v·∫Ω v·∫°ch & AI -->
                        <div class="flex flex-wrap gap-x-6 gap-y-3 items-center">
                            <button id="btnGoToIncident" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg transition duration-200" title="T·∫£i ·∫£nh t√¨nh hu·ªëng vi·ªát v·ªã">
                                üé• T·ªõi S·ª± c·ªë
                            </button>
                            <button id="btnScreenshot" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                üì∏ Ch·ª•p ·∫£nh
                            </button>

                            <div class="h-8 border-l border-gray-500 mx-2 hidden md:block"></div>

                            <!-- C√¥ng c·ª• v·∫Ω v·∫°ch -->
                            <div class="flex flex-wrap gap-3 items-center">
                                <span class="text-lg font-medium hidden sm:inline mr-2">V·∫Ω v·∫°ch:</span>
                                <button id="btnDrawRedLine" class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg transition duration-200" title="V·∫Ω v·∫°ch ƒê·ªè (T·∫•n c√¥ng)">Tƒê</button>
                                <button id="btnDrawBlueLine" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg transition duration-200" title="V·∫Ω v·∫°ch Xanh (H·∫≠u v·ªá)">HV</button>
                                <button id="btnClearLines" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg transition duration-200" title="X√≥a v·∫°ch">X√≥a</button>
                            </div>
                            
                            <div class="h-8 border-l border-gray-500 mx-2 hidden md:block"></div>
                            
                            <!-- N√∫t AI -->
                            <button id="btnToggleDetection" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                ü§ñ B·∫≠t Detect
                            </button>
                            
                            <span id="videoStatus" class="text-gray-300 ml-auto">ƒê√£ d·ª´ng</span>
                        </div>

                        <!-- H√†ng 2 (G·ªòP): ƒêi·ªÅu khi·ªÉn ph√°t l·∫°i, T·ªëc ƒë·ªô & B·ªë c·ª•c -->
                        <div class="flex flex-wrap gap-x-4 gap-y-3 items-center mt-4 pt-4 border-t border-gray-600">
                            <!-- Ph√°t l·∫°i -->
                            <button id="btnBack3s" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition duration-200" title="L√πi 3s">
                                &laquo; 3s
                            </button>
                            <button id="btnTogglePlay" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                ‚ñ∂Ô∏è Ph√°t
                            </button>
                            <button id="btnForward3s" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition duration-200" title="T·ªõi 3s">
                                3s &raquo;
                            </button>
                            
                            <div class="h-8 border-l border-gray-500 mx-1"></div>

                            <!-- Frame -->
                            <button id="btnPrevFrame" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg transition duration-200" title="Frame tr∆∞·ªõc">
                                &lt;|
                            </button>
                            <button id="btnNextFrame" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg transition duration-200" title="Frame sau">
                                |&gt;
                            </button>

                            <div class="h-8 border-l border-gray-500 mx-1"></div>

                            <!-- T·ªëc ƒë·ªô -->
                            <div>
                                <label for="speedSelect" class="text-sm font-medium text-gray-300 sr-only">T·ªëc ƒë·ªô:</label>
                                <select id="speedSelect" class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 py-2 px-3" title="T·ªëc ƒë·ªô ph√°t">
                                    <option value="0.25">0.25x</option>
                                    <option value="0.5">0.5x</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1" selected>1x</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="1.75">1.75x</option>
                                    <option value="2">2x</option>
                                </select>
                            </div>
                            
                            <!-- B·ªë c·ª•c -->
                            <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-300 sr-only">B·ªë c·ª•c:</span>
                                <div class="flex">
                                    <button id="btnLayoutSingle" class="layout-btn bg-blue-600 text-white py-2 px-3 rounded-l-lg transition duration-200" title="B·ªë c·ª•c ƒê∆°n">ƒê∆°n</button>
                                    <button id="btnLayoutGrid" class="layout-btn bg-gray-600 text-white py-2 px-3 rounded-r-lg transition duration-200" title="B·ªë c·ª•c X·∫øp k·ªÅ">X·∫øp k·ªÅ</button>
                                </div>
                                <input type="number" id="gridInput" class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg py-2 px-3 w-20 ml-2 hidden" placeholder="S·ªë √¥" value="4">
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- C·ªôt b√™n ph·∫£i: C√°c g√≥c m√°y & Quy·∫øt ƒë·ªãnh -->
            <div class="lg:w-1/3 flex flex-col gap-6">
                
                <!-- C√°c g√≥c m√°y quay -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-4">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h2 class="text-2xl font-semibold">G√≥c m√°y quay</h2>
                        <button id="btnOpenAddCameraModal" class="bg-blue-600 hover:bg-blue-700 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center transition duration-200" title="Th√™m camera m·ªõi">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                    <!-- Thanh cu·ªôn ngang ch·ª©a c√°c g√≥c m√°y -->
                    <div id="cameraAngleContainer" class="flex overflow-x-auto gap-3 pb-2">
                        <!-- Camera 1 -->
                        <div id="cam-init-1" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/22c55e/ffffff?text=Main+Cam" 
                                 alt="Main Cam" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/22c55e/ffffff?text=Main+Cam">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Main Cam</span>
                            <!-- N√∫t 3 ch·∫•m -->
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                            </button>
                            <!-- Menu t√πy ch·ªçn -->
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10">
                                <a href="#" class="btn-rename-camera block px-4 py-2 text-sm hover:bg-gray-200">ƒê·ªïi t√™n</a>
                                <a href="#" class="btn-delete-camera block px-4 py-2 text-sm text-red-600 hover:bg-gray-200">X√≥a</a>
                            </div>
                        </div>
                        <!-- Camera 2 -->
                        <div id="cam-init-2" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/eab308/ffffff?text=G√≥c+16m50" 
                                 alt="G√≥c 16m50" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/eab308/ffffff?text=G√≥c+16m50">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">G√≥c 16m50</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10">
                                <a href="#" class="btn-rename-camera block px-4 py-2 text-sm hover:bg-gray-200">ƒê·ªïi t√™n</a>
                                <a href="#" class="btn-delete-camera block px-4 py-2 text-sm text-red-600 hover:bg-gray-200">X√≥a</a>
                            </div>
                        </div>
                        <!-- Camera 3 -->
                        <div id="cam-init-3" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/ef4444/ffffff?text=Sau+g√¥n+A" 
                                 alt="Sau g√¥n A" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/ef4444/ffffff?text=Sau+g√¥n+A">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau g√¥n A</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10">
                                <a href="#" class="btn-rename-camera block px-4 py-2 text-sm hover:bg-gray-200">ƒê·ªïi t√™n</a>
                                <a href="#" class="btn-delete-camera block px-4 py-2 text-sm text-red-600 hover:bg-gray-200">X√≥a</a>
                            </div>
                        </div>
                        <!-- Camera 4 -->
                        <div id="cam-init-4" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/3b82f6/ffffff?text=Sau+g√¥n+B" 
                                 alt="Sau g√¥n B" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/3b82f6/ffffff?text=Sau+g√¥n+B">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau g√¥n B</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10">
                                <a href="#" class="btn-rename-camera block px-4 py-2 text-sm hover:bg-gray-200">ƒê·ªïi t√™n</a>
                                <a href="#" class="btn-delete-camera block px-4 py-2 text-sm text-red-600 hover:bg-gray-200">X√≥a</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quy·∫øt ƒë·ªãnh c·ªßa VAR -->
                <!-- lg:sticky top-6 ƒë·∫£m b·∫£o n√≥ d√≠nh l·∫°i khi cu·ªôn tr√™n desktop -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-4 lg:sticky top-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Ra quy·∫øt ƒë·ªãnh</h2>
                    <div class="space-y-3">
                        <button class="decision-btn w-full text-lg bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200" data-decision="B√ÄN TH·∫ÆNG H·ª¢P L·ªÜ">
                            ‚úÖ B√†n th·∫Øng
                        </button>
                        <button class="decision-btn w-full text-lg bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200" data-decision="KH√îNG C√ì B√ÄN TH·∫ÆNG (Vi·ªát v·ªã)">
                            ‚ùå Kh√¥ng c√≥ b√†n th·∫Øng
                        </button>
                        <button class="decision-btn w-full text-lg bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200" data-decision="TH·∫∫ V√ÄNG">
                            üü® Th·∫ª v√†ng
                        </button>
                        <button class="decision-btn w-full text-lg bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-4 rounded-lg transition duration-200" data-decision="TH·∫∫ ƒê·ªé">
                            üü• Th·∫ª ƒë·ªè
                        </button>
                        <button class="decision-btn w-full text-lg bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200" data-decision="PENALTY">
                            üÖøÔ∏è Penalty
                        </button>
                    </div>
                    <div id="finalDecisionBox" class="mt-4 p-4 bg-gray-900 rounded-lg text-center hidden">
                        <h3 class="text-lg font-bold text-yellow-400">QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h3>
                        <p id="decisionText" class="text-2xl font-bold mt-2"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer c·ªë ƒë·ªãnh -->
    <!-- S·ª¨A L·ªñI: flex-shrink-0 ngƒÉn n√≥ co l·∫°i -->
    <footer class="w-full bg-gray-950 text-gray-400 p-2 border-t border-gray-700 flex-shrink-0">
        <div class="container mx-auto max-w-7xl px-4 flex justify-between items-center">
            <!-- ƒê·ªìng h·ªì -->
            <div id="clockDate" class="text-sm font-medium">ƒêang t·∫£i...</div>
            
            <!-- Gh√©p ƒë√¥i -->
            <div id="pairing-section" class="flex items-center gap-2">
                <div id="pairing-default-view" class="flex items-center gap-2">
                    <button id="btnGetPairCode" class="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        L·∫§Y M√É GH√âP ƒê√îI
                    </button>
                </div>
                <div id="pairing-code-view" class="hidden items-center gap-3">
                    <span class="text-lg font-bold tracking-widest text-yellow-400" id="pairCodeDisplay"></span>
                    <div class="flex items-center text-gray-500 text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="pairingTimer">05:00</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    
    <!-- === C√ÅC C·ª¨A S·ªî POPUP (MODAL) === -->

    <!-- Modal: ƒê·ªïi t√™n Camera -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">ƒê·ªïi t√™n Camera</h3>
            <input type="text" id="renameInput" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2" placeholder="Nh·∫≠p t√™n m·ªõi...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelRename" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnSaveRename" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">L∆∞u</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: X√°c nh·∫≠n X√≥a Camera -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">X√°c nh·∫≠n X√≥a</h3>
            <p class="text-gray-300 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a g√≥c m√°y quay n√†y kh√¥ng?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelDelete" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">OK, X√≥a</button>
            </div>
        </div>
    </div>

    <!-- Modal: Th√™m Camera M·ªõi (Th·ªß c√¥ng) -->
    <div id="addCameraModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Th√™m Camera</h3>
            <input type="text" id="addCameraNameInput" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2" placeholder="Nh·∫≠p t√™n camera m·ªõi...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelAddCamera" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmAddCamera" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Th√™m</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: X√°c nh·∫≠n Gh√©p ƒë√¥i (WebRTC) -->
    <div id="pairingModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Y√™u c·∫ßu Gh√©p ƒë√¥i</h3>
            <p class="text-gray-300 mb-6">M·ªôt thi·∫øt b·ªã (ID: <span id="incomingPeerId" class="font-bold">...</span>) ƒëang c·ªë g·∫Øng k·∫øt n·ªëi. B·∫°n c√≥ ch·∫•p nh·∫≠n kh√¥ng?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnRejectPairing" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Kh√¥ng ph·∫£i</button>
                <button type="button" id="btnAcceptPairing" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Ph·∫£i</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Ch·ªçn V·ªã tr√≠ Camera (WebRTC) -->
    <div id="selectCameraSlotModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Ch·ªçn V·ªã tr√≠ Camera</h3>
            <p class="text-gray-300 mb-4">ƒê·∫∑t camera m·ªõi n√†y v√†o v·ªã tr√≠ n√†o?</p>
            <select id="cameraSlotSelect" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 mb-4">
                <option value="new">-- Th√™m l√†m camera m·ªõi --</option>
                <!-- C√°c camera hi·ªán c√≥ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
            </select>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelSelectSlot" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmSelectSlot" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    <!-- ================================== -->
    <!-- === SCRIPT CH√çNH C·ª¶A ·ª®NG D·ª§NG === -->
    <!-- ================================== -->
    <script type="module">
        // Bi·∫øn to√†n c·ª•c cho PeerJS
        let peer = null;
        let currentPeerId = null;
        let pairingTimerInterval = null;
        let incomingConnection = null; // L∆∞u k·∫øt n·ªëi (DataConnection)
        let incomingCall = null; // L∆∞u cu·ªôc g·ªçi (MediaConnection)
        
        // Bi·∫øn to√†n c·ª•c cho AI
        let faceModel = null;
        let objectModel = null;
        let isDetectionRunning = false;
        let detectionInterval = null;
        
        // Bi·∫øn to√†n c·ª•c cho Camera Modals
        let activeCameraElement = null; // Camera ƒëang ƒë∆∞·ª£c s·ª≠a/x√≥a

        // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
        
        /**
         * H√†m sleep an to√†n
         */
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * Ph√°t video m·ªôt c√°ch an to√†n, b·∫Øt l·ªói interrupt
         */
        async function playVideoSafe(videoElement) {
            if (!videoElement) return;
            // Th√™m 'muted' ƒë·ªÉ ƒë·∫£m b·∫£o autoplay ho·∫°t ƒë·ªông
            videoElement.muted = true;
            try {
                await videoElement.play();
            } catch (error) {
                if (error.name === 'AbortError' || error.message.includes('interrupted')) {
                    // ƒê√¢y l√† l·ªói b√¨nh th∆∞·ªùng khi play() b·ªã ng·∫Øt, b·ªè qua
                    // console.log("Video play interrupted, this is normal.");
                } else {
                    console.error(`L·ªói ph√°t video (${videoElement.id || 'N/A'}):`, error.message);
                }
            }
        }
        
        /**
         * Hi·ªÉn th·ªã modal
         */
        function showModal(modalElement) {
            if (modalElement) modalElement.classList.remove('hidden');
        }

        /**
         * ·∫®n modal
         */
        function hideModal(modalElement) {
            if (modalElement) modalElement.classList.add('hidden');
        }

        // --- H√ÄM KH·ªûI T·∫†O CH√çNH ---
        
        async function main() {
            // Kh·ªüi t·∫°o c√°c bi·∫øn DOM
            const mainVideoFeedImage = document.getElementById('mainVideoFeedImage');
            const mainVideoFeedVideo = document.getElementById('mainVideoFeedVideo');
            const cameraAngleContainer = document.getElementById('cameraAngleContainer');
            const btnGoToIncident = document.getElementById('btnGoToIncident');
            const btnTogglePlay = document.getElementById('btnTogglePlay');
            const videoStatus = document.getElementById('videoStatus');
            const decisionButtons = document.querySelectorAll('.decision-btn');
            const finalDecisionBox = document.getElementById('finalDecisionBox');
            const decisionText = document.getElementById('decisionText');
            
            const canvas = document.getElementById('reviewCanvas');
            const ctx = canvas.getContext('2d');
            const btnDrawRedLine = document.getElementById('btnDrawRedLine');
            const btnDrawBlueLine = document.getElementById('btnDrawBlueLine');
            const btnClearLines = document.getElementById('btnClearLines');

            const btnLayoutSingle = document.getElementById('btnLayoutSingle');
            const btnLayoutGrid = document.getElementById('btnLayoutGrid');
            const gridInput = document.getElementById('gridInput');
            const singleView = document.getElementById('singleView');
            const gridView = document.getElementById('gridView');
            
            // ƒê·ªìng h·ªì
            const clockDateElement = document.getElementById('clockDate');

            // C√°c n√∫t Camera Modal
            const btnOpenAddCameraModal = document.getElementById('btnOpenAddCameraModal');
            const addCameraModal = document.getElementById('addCameraModal');
            const btnCancelAddCamera = document.getElementById('btnCancelAddCamera');
            const btnConfirmAddCamera = document.getElementById('btnConfirmAddCamera');
            const addCameraNameInput = document.getElementById('addCameraNameInput');

            const renameModal = document.getElementById('renameModal');
            const btnCancelRename = document.getElementById('btnCancelRename');
            const btnSaveRename = document.getElementById('btnSaveRename');
            const renameInput = document.getElementById('renameInput');

            const deleteModal = document.getElementById('deleteModal');
            const btnCancelDelete = document.getElementById('btnCancelDelete');
            const btnConfirmDelete = document.getElementById('btnConfirmDelete');

            // C√°c n√∫t Pairing Modal
            const btnGetPairCode = document.getElementById('btnGetPairCode');
            const pairingDefaultView = document.getElementById('pairing-default-view');
            const pairingCodeView = document.getElementById('pairing-code-view');
            const pairCodeDisplay = document.getElementById('pairCodeDisplay');
            const pairingTimer = document.getElementById('pairingTimer');
            const pairingModal = document.getElementById('pairingModal');
            const btnRejectPairing = document.getElementById('btnRejectPairing');
            const btnAcceptPairing = document.getElementById('btnAcceptPairing');
            const incomingPeerId = document.getElementById('incomingPeerId');

            // C√°c n√∫t Select Slot Modal
            const selectCameraSlotModal = document.getElementById('selectCameraSlotModal');
            const cameraSlotSelect = document.getElementById('cameraSlotSelect');
            const btnCancelSelectSlot = document.getElementById('btnCancelSelectSlot');
            const btnConfirmSelectSlot = document.getElementById('btnConfirmSelectSlot');
            
            // AI Detection
            const btnToggleDetection = document.getElementById('btnToggleDetection');
            const detectionCanvas = document.getElementById('detectionCanvas');
            const detCtx = detectionCanvas.getContext('2d');

            let isPlaying = false;
            let currentLineColor = 'red';
            let isDrawing = false;
            let startX, startY;
            const incidentImageSrc = 'https://placehold.co/1920x1080/db2777/ffffff?text=T√¨nh+hu·ªëng+Vi·ªát+v·ªã';
            
            // --- 0. KH·ªûI T·∫†O ƒê·ªíNG H·ªí ---
            function updateClock() {
                const now = new Date();
                const options = {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour12: false
                };
                if (clockDateElement) {
                    clockDateElement.textContent = now.toLocaleDateString('vi-VN', options);
                }
            }
            setInterval(updateClock, 1000);
            updateClock();

            // --- 1. H√ÄM V·∫º V·∫†CH (CANVAS) ---
            function resizeCanvas(sourceElement) {
                if (!sourceElement || !canvas) return;
                
                // Ch·ªù m·ªôt frame ƒë·ªÉ DOM c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc
                requestAnimationFrame(() => {
                    // Ph·∫£i l·∫•y 'reviewScreen' l√†m g·ªëc v√¨ sourceElement (video/img)
                    // c√≥ th·ªÉ c√≥ k√≠ch th∆∞·ªõc 0 t·∫°m th·ªùi
                    const reviewScreen = document.getElementById('reviewScreen');
                    if (!reviewScreen) return;
                    
                    const rect = reviewScreen.getBoundingClientRect();
                    
                    if (rect.width === 0 || rect.height === 0) return;
                    
                    // C·∫≠p nh·∫≠t canvas v·∫Ω v·∫°ch
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    canvas.style.width = `${rect.width}px`;
                    canvas.style.height = `${rect.height}px`;
                    
                    // C·∫≠p nh·∫≠t canvas AI
                    detectionCanvas.width = rect.width;
                    detectionCanvas.height = rect.height;
                    detectionCanvas.style.width = `${rect.width}px`;
                    detectionCanvas.style.height = `${rect.height}px`;
                });
            }

            window.addEventListener('resize', () => {
                const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                resizeCanvas(currentFeed);
            });
            mainVideoFeedImage.onload = () => resizeCanvas(mainVideoFeedImage);
            mainVideoFeedVideo.onloadedmetadata = () => resizeCanvas(mainVideoFeedVideo);
            // G·ªçi l·∫ßn ƒë·∫ßu
            resizeCanvas(mainVideoFeedImage);


            function clearLines() {
                if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function getMousePos(evt) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                let clientX = evt.clientX;
                let clientY = evt.clientY;

                if (evt.touches && evt.touches.length > 0) {
                    clientX = evt.touches[0].clientX;
                    clientY = evt.touches[0].clientY;
                }

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                e.preventDefault();
                if (singleView.classList.contains('hidden')) return;
                
                isDrawing = true;
                const pos = getMousePos(e);
                startX = pos.x;
                startY = pos.y;
            }

            function draw(e) {
                e.preventDefault();
                if (!isDrawing || singleView.classList.contains('hidden')) return;

                // X√≥a v·∫°ch c≈© v√† v·∫Ω v·∫°ch m·ªõi theo th·ªùi gian th·ª±c
                clearLines(); 
                const pos = getMousePos(e);
                
                ctx.beginPath();
                ctx.strokeStyle = currentLineColor;
                ctx.lineWidth = 4;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.moveTo(startX, startY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stopDrawing(e) {
                e.preventDefault();
                isDrawing = false;
            }

            if (canvas) {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);
                canvas.addEventListener('touchcancel', stopDrawing);
            }
            
            if (btnDrawRedLine) btnDrawRedLine.addEventListener('click', () => currentLineColor = '#ef4444');
            if (btnDrawBlueLine) btnDrawBlueLine.addEventListener('click', () => currentLineColor = '#3b82f6');
            if (btnClearLines) btnClearLines.addEventListener('click', clearLines);

            // --- 2. H√ÄM ƒêI·ªÄU KHI·ªÇN CH√çNH ---

            // Chuy·ªÉn g√≥c m√°y (khi click thumbnail)
            function setupCameraAngleClick(camElement) {
                camElement.addEventListener('click', async (e) => {
                    // NgƒÉn click v√†o menu/n√∫t 3 ch·∫•m
                    if (e.target.closest('.btn-camera-options') || e.target.closest('.camera-menu')) {
                        return;
                    }

                    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô l∆∞·ªõi, chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô ƒë∆°n
                    if (gridView.classList.contains('hidden') === false) {
                        if (btnLayoutSingle) btnLayoutSingle.click();
                    }
                    
                    clearLines(); // X√≥a v·∫°ch khi ƒë·ªïi cam
                    
                    const imgSrc = camElement.dataset.src;
                    const videoStream = camElement.videoStream; // L·∫•y stream (n·∫øu c√≥)

                    if (videoStream) {
                        // ƒê√¢y l√† camera WebRTC (Video)
                        mainVideoFeedImage.classList.add('hidden');
                        mainVideoFeedVideo.classList.remove('hidden');
                        mainVideoFeedVideo.srcObject = videoStream;
                        await playVideoSafe(mainVideoFeedVideo);
                        resizeCanvas(mainVideoFeedVideo);
                    } else if (imgSrc) {
                        // ƒê√¢y l√† camera ·∫£nh
                        mainVideoFeedImage.classList.remove('hidden');
                        mainVideoFeedVideo.classList.add('hidden');
                        if (mainVideoFeedVideo.srcObject) {
                            mainVideoFeedVideo.srcObject.getTracks().forEach(track => track.stop());
                        }
                        mainVideoFeedVideo.srcObject = null;
                        mainVideoFeedImage.src = imgSrc;
                        resizeCanvas(mainVideoFeedImage);
                    }
                });
            }
            
            // G√°n s·ª± ki·ªán cho c√°c camera ban ƒë·∫ßu
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraAngleClick);

            // T·ªõi s·ª± c·ªë
            if (btnGoToIncident) {
                btnGoToIncident.addEventListener('click', () => {
                    if (gridView.classList.contains('hidden') === false) {
                        if (btnLayoutSingle) btnLayoutSingle.click();
                    }
                    
                    mainVideoFeedImage.classList.remove('hidden');
                    mainVideoFeedVideo.classList.add('hidden');
                    if (mainVideoFeedVideo.srcObject) {
                        mainVideoFeedVideo.srcObject.getTracks().forEach(track => track.stop());
                    }
                    mainVideoFeedVideo.srcObject = null;
                    mainVideoFeedImage.src = incidentImageSrc;
                    
                    if (videoStatus) videoStatus.textContent = 'ƒê√É D·ª™NG (S·ª± c·ªë)';
                    if (btnTogglePlay) btnTogglePlay.textContent = '‚ñ∂Ô∏è Ph√°t';
                    isPlaying = false;
                    resizeCanvas(mainVideoFeedImage);
                });
            }

            // Ph√°t/D·ª´ng (M√¥ ph·ªèng)
            if (btnTogglePlay) {
                btnTogglePlay.addEventListener('click', async () => {
                    isPlaying = !isPlaying;
                    const currentFeed = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;

                    if (isPlaying) {
                        if (videoStatus) videoStatus.textContent = 'ƒêang ph√°t...';
                        btnTogglePlay.textContent = '‚è∏Ô∏è D·ª´ng';
                        if (currentFeed) await playVideoSafe(currentFeed);
                    } else {
                        if (videoStatus) videoStatus.textContent = 'ƒê√£ d·ª´ng';
                        btnTogglePlay.textContent = '‚ñ∂Ô∏è Ph√°t';
                        if (currentFeed) currentFeed.pause();
                    }
                });
            }

            // Ra quy·∫øt ƒë·ªãnh
            decisionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const decision = btn.dataset.decision;
                    if (decisionText) decisionText.textContent = decision;
                    if (finalDecisionBox) finalDecisionBox.classList.remove('hidden');
                    decisionButtons.forEach(b => b.classList.remove('active', 'border-yellow-400', 'border-4'));
                    btn.classList.add('active', 'border-yellow-400', 'border-4');
                });
            });

            // --- 3. H√ÄM QU·∫¢N L√ù B·ªê C·ª§C (Layout) ---

            if (btnLayoutSingle) {
                btnLayoutSingle.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.add('hidden');
                    if (singleView) singleView.classList.remove('hidden');
                    if (gridView) gridView.classList.add('hidden');
                    
                    btnLayoutSingle.classList.add('active', 'bg-blue-600');
                    btnLayoutSingle.classList.remove('bg-gray-600');
                    if (btnLayoutGrid) {
                        btnLayoutGrid.classList.remove('active', 'bg-blue-600');
                        btnLayoutGrid.classList.add('bg-gray-600');
                    }
                    
                    // Resize canvas khi quay l·∫°i
                    const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                    resizeCanvas(currentFeed);
                });
            }
            
            if (btnLayoutGrid) {
                btnLayoutGrid.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.remove('hidden');
                    if (singleView) singleView.classList.add('hidden');
                    if (gridView) gridView.classList.remove('hidden');

                    btnLayoutGrid.classList.add('active', 'bg-blue-600');
                    btnLayoutGrid.classList.remove('bg-gray-600');
                    if (btnLayoutSingle) {
                        btnLayoutSingle.classList.remove('active', 'bg-blue-600');
                        btnLayoutSingle.classList.add('bg-gray-600');
                    }

                    updateGridView();
                });
            }

            function updateGridView() {
                if (!gridView || !gridInput) return;
                
                const count = parseInt(gridInput.value) || 4;
                const cols = Math.ceil(Math.sqrt(count));
                gridView.className = `w-full h-full grid gap-1 grid-cols-${cols}`;
                gridView.innerHTML = '';
                
                const sources = Array.from(document.querySelectorAll('.camera-angle-wrapper'));
                
                for (let i = 0; i < count; i++) {
                    const sourceElement = sources[i % sources.length]; // L·∫•y ngu·ªìn, l·∫∑p l·∫°i n·∫øu kh√¥ng ƒë·ªß
                    if (!sourceElement) continue;

                    if (sourceElement.videoStream) {
                        // L√† video stream
                        const videoElement = document.createElement('video');
                        videoElement.srcObject = sourceElement.videoStream;
                        videoElement.className = 'w-full h-full object-cover bg-black'; // D√πng cover
                        videoElement.autoplay = true;
                        videoElement.muted = true;
                        videoElement.playsinline = true;
                        gridView.appendChild(videoElement);
                        playVideoSafe(videoElement);
                    } else if (sourceElement.dataset.src) {
                        // L√† ·∫£nh
                        const imgElement = document.createElement('img');
                        imgElement.src = sourceElement.dataset.src;
                        imgElement.alt = `Camera ${i + 1}`;
                        imgElement.className = 'w-full h-full object-cover bg-black'; // D√πng cover
                        gridView.appendChild(imgElement);
                    }
                }
            }
            if (gridInput) gridInput.addEventListener('input', updateGridView);

            // --- 4. H√ÄM QU·∫¢N L√ù CAMERA (Th√™m/S·ª≠a/X√≥a) ---

            function createNewCameraElement(id, name, imgSrc, stream = null) {
                const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                const placeholderImg = `https://placehold.co/300x200/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;
                const placeholderSrc = `https://placehold.co/1920x1080/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;

                const wrapper = document.createElement('div');
                wrapper.id = id;
                wrapper.className = "camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition";
                
                const img = document.createElement('img');
                img.className = "camera-angle camera-angle-image w-full h-full object-cover"; // D√πng cover
                img.alt = name;
                
                const video = document.createElement('video');
                video.className = "camera-angle-video hidden";
                video.autoplay = true;
                video.muted = true;
                video.playsinline = true;

                if (stream) {
                    wrapper.videoStream = stream; // G√°n stream
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    img.classList.add('hidden');
                    // Kh√¥ng g√°n data-src cho video stream
                } else {
                    img.src = imgSrc || placeholderImg;
                    wrapper.dataset.src = imgSrc || placeholderSrc;
                    video.classList.add('hidden');
                    img.classList.remove('hidden');
                }

                wrapper.innerHTML = `
                    ${img.outerHTML}
                    ${video.outerHTML}
                    <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">${name}</span>
                    <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                    </button>
                    <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10">
                        <a href="#" class="btn-rename-camera block px-4 py-2 text-sm hover:bg-gray-200">ƒê·ªïi t√™n</a>
                        <a href="#" class="btn-delete-camera block px-4 py-2 text-sm text-red-600 hover:bg-gray-200">X√≥a</a>
                    </div>
                `;
                
                // G√°n l·∫°i s·ª± ki·ªán cho camera m·ªõi
                setupCameraAngleClick(wrapper);
                setupCameraOptionEvents(wrapper);
                
                // Ph√°t video thumbnail n·∫øu l√† stream
                if (stream) {
                    playVideoSafe(wrapper.querySelector('.camera-angle-video'));
                }
                
                return wrapper;
            }

            function setupCameraOptionEvents(cameraElement) {
                const btnOptions = cameraElement.querySelector('.btn-camera-options');
                const btnRename = cameraElement.querySelector('.btn-rename-camera');
                const btnDelete = cameraElement.querySelector('.btn-delete-camera');
                const menu = cameraElement.querySelector('.camera-menu');

                if (btnOptions) {
                    btnOptions.addEventListener('click', (e) => {
                        e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click v√†o camera
                        if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                if (btnRename) {
                    btnRename.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement; // L∆∞u camera ƒëang ƒë∆∞·ª£c s·ª≠a
                        if (renameInput) renameInput.value = cameraElement.querySelector('.camera-name').textContent;
                        showModal(renameModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
                
                if (btnDelete) {
                    btnDelete.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement; // L∆∞u camera ƒëang ƒë∆∞·ª£c x√≥a
                        showModal(deleteModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
            }
            
            // G√°n s·ª± ki·ªán cho c√°c n√∫t T√πy ch·ªçn c·ªßa camera ban ƒë·∫ßu
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraOptionEvents);
            
            // Th√™m camera (th·ªß c√¥ng)
            if (btnOpenAddCameraModal) btnOpenAddCameraModal.addEventListener('click', () => showModal(addCameraModal));
            if (btnCancelAddCamera) btnCancelAddCamera.addEventListener('click', () => hideModal(addCameraModal));
            if (btnConfirmAddCamera) {
                btnConfirmAddCamera.addEventListener('click', () => {
                    const name = addCameraNameInput.value.trim();
                    if (name) {
                        const newId = `cam-${Date.now()}`;
                        const newCam = createNewCameraElement(newId, name, null);
                        if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                        addCameraNameInput.value = '';
                        hideModal(addCameraModal);
                    }
                });
            }
            
            // ƒê·ªïi t√™n camera
            if (btnCancelRename) btnCancelRename.addEventListener('click', () => hideModal(renameModal));
            if (btnSaveRename) {
                btnSaveRename.addEventListener('click', () => {
                    const newName = renameInput.value.trim();
                    if (newName && activeCameraElement) {
                        const nameSpan = activeCameraElement.querySelector('.camera-name');
                        if (nameSpan) nameSpan.textContent = newName;
                        
                        const img = activeCameraElement.querySelector('.camera-angle-image');
                        if (img) {
                             img.alt = newName;
                        }
                        
                        // C·∫≠p nh·∫≠t data-src n·∫øu l√† ·∫£nh
                        if (activeCameraElement.dataset.src) {
                            try {
                                const oldSrc = new URL(activeCameraElement.dataset.src);
                                oldSrc.searchParams.set('text', newName);
                                activeCameraElement.dataset.src = oldSrc.href;
                                
                                const thumbImg = activeCameraElement.querySelector('.camera-angle-image');
                                if (thumbImg) {
                                    const oldThumbSrc = new URL(thumbImg.src);
                                    oldThumbSrc.searchParams.set('text', newName);
                                    thumbImg.src = oldThumbSrc.href;
                                }
                            } catch(e) {
                                console.warn("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t text c·ªßa placeholder image", e);
                            }
                        }
                    }
                    hideModal(renameModal);
                    activeCameraElement = null;
                });
            }

            // X√≥a camera
            if (btnCancelDelete) btnCancelDelete.addEventListener('click', () => hideModal(deleteModal));
            if (btnConfirmDelete) {
                btnConfirmDelete.addEventListener('click', () => {
                    if (activeCameraElement) {
                        // T·∫Øt stream video n·∫øu c√≥
                        if (activeCameraElement.videoStream) {
                            activeCameraElement.videoStream.getTracks().forEach(track => track.stop());
                        }
                        activeCameraElement.remove();
                    }
                    hideModal(deleteModal);
                    activeCameraElement = null;
                });
            }


            // --- 5. H√ÄM QU·∫¢N L√ù PEERJS (WebRTC) ---
            
            function initializePeer(id) {
                if (peer) {
                    peer.destroy();
                }
                
                try {
                    peer = new Peer(id, {
                        // host: 'localhost', // B·ªè comment n·∫øu d√πng server PeerJS t·ª± host
                        // port: 9000,
                        // path: '/myapp',
                        debug: 2
                    });
                } catch (e) {
                    console.error("Kh√¥ng th·ªÉ kh·ªüi t·∫°o PeerJS. PeerJS c√≥ ƒë∆∞·ª£c t·∫£i kh√¥ng?", e);
                    return;
                }

                peer.on('open', (id) => {
                    console.log('PeerJS ƒë√£ s·∫µn s√†ng. ID c·ªßa t√¥i l√†:', id);
                });

                peer.on('error', (err) => {
                    console.error('L·ªói PeerJS:', err);
                    if (err.type === 'peer-unavailable') {
                        alert('Kh√¥ng t√¨m th·∫•y m√£ gh√©p ƒë√¥i. Vui l√≤ng th·ª≠ l·∫°i.');
                        resetPairing();
                    }
                });
                
                // L·∫Øng nghe y√™u c·∫ßu k·∫øt n·ªëi (DataConnection)
                peer.on('connection', (conn) => {
                    console.log('Ph√°t hi·ªán k·∫øt n·ªëi ƒë·∫øn:', conn.peer);
                    incomingConnection = conn;
                    if (incomingPeerId) incomingPeerId.textContent = conn.peer;
                    showModal(pairingModal);
                });
                
                // L·∫Øng nghe cu·ªôc g·ªçi (MediaConnection)
                peer.on('call', (call) => {
                    console.log('Nh·∫≠n ƒë∆∞·ª£c cu·ªôc g·ªçi video t·ª´:', call.peer);
                    
                    // N·∫øu ch∆∞a ch·∫•p nh·∫≠n DataConnection, t·∫°m th·ªùi l∆∞u cu·ªôc g·ªçi
                    if (!incomingConnection || incomingConnection.peer !== call.peer) {
                         console.log("Cu·ªôc g·ªçi ƒë·∫øn tr∆∞·ªõc khi x√°c nh·∫≠n. L∆∞u l·∫°i.");
                         incomingCall = call;
                         if (incomingPeerId) incomingPeerId.textContent = call.peer;
                         showModal(pairingModal);
                         return; // Ch·ªù x√°c nh·∫≠n
                    }
                    
                    // N·∫øu ƒë√£ x√°c nh·∫≠n, m·ªü modal ch·ªçn v·ªã tr√≠
                    openSelectSlotModal(call);
                });
            }
            
            function openSelectSlotModal(call) {
                incomingCall = call; // L∆∞u cu·ªôc g·ªçi
                
                // C·∫≠p nh·∫≠t danh s√°ch camera
                if (cameraSlotSelect) {
                    cameraSlotSelect.innerHTML = '<option value="new">-- Th√™m l√†m camera m·ªõi --</option>';
                    document.querySelectorAll('.camera-angle-wrapper').forEach(cam => {
                        const nameSpan = cam.querySelector('.camera-name');
                        if (nameSpan) {
                            const name = nameSpan.textContent;
                            const id = cam.id;
                            cameraSlotSelect.innerHTML += `<option value="${id}">Thay th·∫ø: ${name}</option>`;
                        }
                    });
                }
                
                hideModal(pairingModal);
                showModal(selectCameraSlotModal);
            }

            function generatePairCode() {
                // T·∫°o m√£ 6 ch·ªØ c√°i ng·∫´u nhi√™n
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function startPairingTimer() {
                let timeLeft = 300; // 5 ph√∫t
                if (pairingTimer) pairingTimer.textContent = '05:00';
                
                if (pairingTimerInterval) clearInterval(pairingTimerInterval);

                pairingTimerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const seconds = (timeLeft % 60).toString().padStart(2, '0');
                    if (pairingTimer) pairingTimer.textContent = `${minutes}:${seconds}`;

                    if (timeLeft <= 0) {
                        resetPairing();
                    }
                }, 1000);
            }

            function resetPairing() {
                clearInterval(pairingTimerInterval);
                if (pairingDefaultView) pairingDefaultView.classList.remove('hidden');
                if (pairingCodeView) pairingCodeView.classList.add('hidden');
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                currentPeerId = null;
            }

            if (btnGetPairCode) {
                btnGetPairCode.addEventListener('click', () => {
                    currentPeerId = generatePairCode();
                    if (pairCodeDisplay) pairCodeDisplay.textContent = currentPeerId;
                    
                    if (pairingDefaultView) pairingDefaultView.classList.add('hidden');
                    if (pairingCodeView) pairingCodeView.classList.remove('hidden');
                    
                    initializePeer(currentPeerId);
                    startPairingTimer();
                });
            }

            // X·ª≠ l√Ω modal X√°c nh·∫≠n gh√©p ƒë√¥i
            if (btnRejectPairing) {
                btnRejectPairing.addEventListener('click', () => {
                    if (incomingConnection) incomingConnection.close();
                    if (incomingCall) incomingCall.close();
                    incomingConnection = null;
                    incomingCall = null;
                    hideModal(pairingModal);
                });
            }
            
            if (btnAcceptPairing) {
                btnAcceptPairing.addEventListener('click', () => {
                    // G·ª≠i t√≠n hi·ªáu ch·∫•p nh·∫≠n (n·∫øu c√≥ DataConnection)
                    if (incomingConnection) {
                        incomingConnection.send('accepted');
                    }
                    
                    // N·∫øu cu·ªôc g·ªçi ƒë√£ ƒë·∫øn, m·ªü modal ch·ªçn v·ªã tr√≠
                    if (incomingCall) {
                        openSelectSlotModal(incomingCall);
                    }
                    // N·∫øu ch∆∞a, ƒë·ª£i cu·ªôc g·ªçi ƒë·∫øn (ƒë√£ x·ª≠ l√Ω ·ªü 'peer.on(call)')
                    
                    hideModal(pairingModal);
                });
            }

            // X·ª≠ l√Ω modal Ch·ªçn V·ªã tr√≠
            if (btnCancelSelectSlot) {
                btnCancelSelectSlot.addEventListener('click', () => {
                    if (incomingCall) incomingCall.close();
                    incomingCall = null;
                    incomingConnection = null;
                    hideModal(selectCameraSlotModal);
                });
            }
            
            if (btnConfirmSelectSlot) {
                btnConfirmSelectSlot.addEventListener('click', () => {
                    const selectedSlotId = cameraSlotSelect.value;
                    
                    if (!incomingCall) {
                        console.error("Kh√¥ng t√¨m th·∫•y cu·ªôc g·ªçi ƒë·∫øn!");
                        hideModal(selectCameraSlotModal);
                        return;
                    }

                    // Tr·∫£ l·ªùi cu·ªôc g·ªçi ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n stream
                    incomingCall.answer(); 
                    
                    incomingCall.on('stream', (remoteStream) => {
                        console.log("ƒê√É NH·∫¨N STREAM VIDEO!", remoteStream);
                        let newOrUpdatedCam;
                        
                        if (selectedSlotId === 'new') {
                            // Th√™m l√†m camera m·ªõi
                            const newId = `cam-webrtc-${incomingCall.peer}`;
                            const newName = `Remote Cam (${incomingCall.peer.slice(0, 4)})`;
                            const newCam = createNewCameraElement(newId, newName, null, remoteStream);
                            if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                            newOrUpdatedCam = newCam;
                        } else {
                            // Thay th·∫ø camera hi·ªán c√≥
                            const slotToReplace = document.getElementById(selectedSlotId);
                            if (slotToReplace) {
                                replaceCameraSlot(slotToReplace, remoteStream);
                                newOrUpdatedCam = slotToReplace;
                            }
                        }
                        
                        // T·ª± ƒë·ªông click v√†o camera v·ª´a th√™m/thay th·∫ø
                        if (newOrUpdatedCam) {
                            newOrUpdatedCam.click();
                        }
                    });
                    
                    incomingCall.on('close', () => {
                        console.log("Stream video ƒë√£ ƒë√≥ng.");
                    });
                    
                    incomingCall.on('error', (err) => {
                        console.error("L·ªói stream:", err);
                    });
                    
                    hideModal(selectCameraSlotModal);
                    incomingCall = null;
                    incomingConnection = null;
                });
            }
            
            function replaceCameraSlot(slotElement, stream) {
                const img = slotElement.querySelector('.camera-angle-image');
                const video = slotElement.querySelector('.camera-angle-video');
                
                // G√°n stream
                slotElement.videoStream = stream;
                if (video) video.srcObject = stream;
                
                // S·ª¨A L·ªñI QUAN TR·ªåNG: X√≥a data-src (n·∫øu kh√¥ng, khi click n√≥ s·∫Ω t·∫£i l·∫°i ·∫£nh)
                slotElement.removeAttribute('data-src');

                // Hi·ªÉn th·ªã video, ·∫©n ·∫£nh
                if (video) video.classList.remove('hidden');
                if (img) img.classList.add('hidden');
                
                // S·ª¨A L·ªñI: Ph√°t video thumbnail
                playVideoSafe(video);
            }
            
            
            // --- 6. H√ÄM QU·∫¢N L√ù AI (TensorFlow.js) ---
            
            async function loadModels() {
                try {
                    if (!window.tf || !window.blazeface || !window.cocoSsd) {
                        console.error("Thi·∫øu th∆∞ vi·ªán TensorFlow.js ho·∫∑c models.");
                        if (videoStatus) videoStatus.textContent = 'L·ªói t·∫£i AI lib!';
                        return;
                    }
                
                    if (videoStatus) videoStatus.textContent = 'ƒêang t·∫£i model AI...';
                    await tf.setBackend('webgl');
                    
                    const p1 = blazeface.load();
                    const p2 = cocoSsd.load();
                    
                    [faceModel, objectModel] = await Promise.all([p1, p2]);
                    
                    console.log("ƒê√£ t·∫£i xong 2 model AI (BlazeFace & COCO-SSD).");
                    if (videoStatus) videoStatus.textContent = 'ƒê√£ d·ª´ng';
                    if (btnToggleDetection) btnToggleDetection.disabled = false;
                } catch (err) {
                    console.error("L·ªói t·∫£i model AI:", err);
                    if (videoStatus) videoStatus.textContent = 'L·ªói t·∫£i AI!';
                }
            }
            
            async function runDetection() {
                if (!isDetectionRunning || (!faceModel && !objectModel) || !detCtx) return;
                
                // Ch·ªçn ngu·ªìn video (ch·ªâ ch·∫°y tr√™n m√†n h√¨nh ch√≠nh)
                const sourceElement = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;
                
                if (!sourceElement || sourceElement.paused || sourceElement.ended || sourceElement.readyState < 2) {
                    // N·∫øu kh√¥ng c√≥ video ho·∫∑c video ƒëang d·ª´ng, clear canvas v√† ƒë·ª£i
                    detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    return;
                }

                // Ch·∫°y c·∫£ 2 model song song
                const p1 = faceModel ? faceModel.estimateFaces(sourceElement, false) : Promise.resolve([]);
                const p2 = objectModel ? objectModel.detect(sourceElement) : Promise.resolve([]);
                
                const [facePredictions, objectPredictions] = await Promise.all([p1, p2]);

                // X√≥a canvas
                detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                detCtx.font = '16px sans-serif';
                detCtx.textBaseline = 'top';

                // S·ª¨A L·ªñI: T√≠nh to√°n t·ª∑ l·ªá cho 'object-cover'
                const videoRatio = sourceElement.videoWidth / sourceElement.videoHeight;
                const canvasRatio = detectionCanvas.width / detectionCanvas.height;
                let scale = 1, offsetX = 0, offsetY = 0;

                if (videoRatio > canvasRatio) {
                    // Video r·ªông h∆°n canvas -> Video b·ªã c·∫Øt tr√°i/ph·∫£i (pillarbox)
                    scale = detectionCanvas.height / sourceElement.videoHeight;
                    offsetX = (detectionCanvas.width - sourceElement.videoWidth * scale) / 2;
                    offsetY = 0;
                } else {
                    // Video cao h∆°n canvas -> Video b·ªã c·∫Øt tr√™n/d∆∞·ªõi (letterbox)
                    scale = detectionCanvas.width / sourceElement.videoWidth;
                    offsetX = 0;
                    offsetY = (detectionCanvas.height - sourceElement.videoHeight * scale) / 2;
                }
                
                // V·∫Ω c√°c h·ªôp khu√¥n m·∫∑t
                facePredictions.forEach(pred => {
                    const [startX, startY] = pred.topLeft;
                    const [endX, endY] = pred.bottomRight;
                    const width = endX - startX;
                    const height = endY - startY;
                    
                    const x = startX * scale + offsetX;
                    const y = startY * scale + offsetY;
                    const w = width * scale;
                    const h = height * scale;

                    detCtx.strokeStyle = '#32CD32'; // Xanh l√°
                    detCtx.lineWidth = 2;
                    detCtx.strokeRect(x, y, w, h);
                    
                    detCtx.fillStyle = '#32CD32';
                    detCtx.fillText('Face', x, y > 18 ? y - 18 : y + h + 4);
                });
                
                // V·∫Ω c√°c h·ªôp v·∫≠t th·ªÉ (ch·ªâ v·∫Ω tr√°i b√≥ng)
                objectPredictions.forEach(pred => {
                    if (pred.class === 'sports ball') {
                        const [startX, startY, width, height] = pred.bbox;
                        
                        const x = startX * scale + offsetX;
                        const y = startY * scale + offsetY;
                        const w = width * scale;
                        const h = height * scale;

                        detCtx.strokeStyle = '#FFD700'; // V√†ng
                        detCtx.lineWidth = 2;
                        detCtx.strokeRect(x, y, w, h);
                        
                        detCtx.fillStyle = '#FFD700';
                        const label = `Ball (${Math.round(pred.score * 100)}%)`;
                        detCtx.fillText(label, x, y > 18 ? y - 18 : y + h + 4);
                    }
                });
            }

            if (btnToggleDetection) {
                btnToggleDetection.disabled = true; // V√¥ hi·ªáu h√≥a cho ƒë·∫øn khi model t·∫£i xong
                
                btnToggleDetection.addEventListener('click', () => {
                    isDetectionRunning = !isDetectionRunning;
                    
                    if (isDetectionRunning) {
                        btnToggleDetection.textContent = 'üõë T·∫Øt Detect';
                        btnToggleDetection.classList.add('bg-red-600', 'hover:bg-red-700');
                        btnToggleDetection.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                        
                        if (detectionInterval) clearInterval(detectionInterval);
                        detectionInterval = setInterval(runDetection, 100); // Ch·∫°y 10 l·∫ßn/gi√¢y
                        
                    } else {
                        btnToggleDetection.textContent = 'ü§ñ B·∫≠t Detect';
                        btnToggleDetection.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btnToggleDetection.classList.add('bg-purple-600', 'hover:bg-purple-700');
                        
                        if (detectionInterval) clearInterval(detectionInterval);
                        if (detCtx) detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height); // X√≥a l·∫ßn cu·ªëi
                    }
                });
            }
            
            // T·∫£i model AI sau khi trang ƒë√£ t·∫£i
            loadModels();
        }

        // Ch·∫°y h√†m main
        // Th√™m ki·ªÉm tra l·ªói n·∫øu 'Peer' kh√¥ng t·ªìn t·∫°i
        if (typeof Peer === 'undefined') {
            alert('L·ªói: Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán PeerJS. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ t·∫£i l·∫°i trang.');
        } else {
            main().catch(console.error);
        }

    </script>
</body>
</html>


