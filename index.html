<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình mô phỏng VAR</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tải PeerJS (thay thế Firebase) -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- Tải TensorFlow.js và các model AI -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@latest/dist/blazeface.min.js"></script>

    <!-- Tải Font Be Vietnam Pro -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    
    <!-- SỬA LỖI: Quay về Material ICONS Round (bản cũ) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* Nền chính */
        html {
            background-image: url('https://images.ctfassets.net/seegk6e7ypwi/60TvXEVrvciW5CvsnqQmYZ/599e887296658b7297caa4400b27196a/fc-26-community-background-image.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        body {
            font-family: "Be Vietnam Pro", sans-serif;
            overflow: hidden;
            background: transparent;
            color: white;
        }
        
        /* Panel nền đen 50% */
        .glass-panel {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        /* Panel hình chữ nhật (dùng cho menu, modal) */
        .glass-panel-rect {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Nút nền đen 50% */
        .glass-button {
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease-in-out;
            color: white; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px; /* rounded-full */
        }
        .glass-button:hover {
            background-color: rgba(20, 20, 20, 0.7); 
        }
        .glass-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Hiệu ứng đàn hồi */
        .glass-button:active, .decision-btn:active, .camera-angle-wrapper:active {
            transform: scale(0.95);
            transition-duration: 0.1s;
        }
        
        /* Nút hình chữ nhật (dùng cho modal) */
        .glass-button-rect {
             border-radius: 0.5rem; /* rounded-lg */
        }
        
        .glass-button.danger { background-color: rgba(220, 38, 38, 0.5); }
        .glass-button.danger:hover { background-color: rgba(220, 38, 38, 0.7); }
        .glass-button.success { background-color: rgba(22, 163, 74, 0.5); }
        .glass-button.success:hover { background-color: rgba(22, 163, 74, 0.7); }
        .glass-button.warning { background-color: rgba(234, 179, 8, 0.5); }
        .glass-button.warning:hover { background-color: rgba(234, 179, 8, 0.7); }
        .glass-button.info { background-color: rgba(59, 130, 246, 0.5); }
        .glass-button.info:hover { background-color: rgba(59, 130, 246, 0.7); }
        .glass-button.purple { background-color: rgba(139, 92, 246, 0.5); }
        .glass-button.purple:hover { background-color: rgba(139, 92, 246, 0.7); }
        .glass-button.active {
            background-color: rgba(59, 130, 246, 0.7); /* Blue */
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        /* Scrollbar tùy chỉnh */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.5); }

        /* CSS tùy chỉnh cho canvas */
        #reviewCanvas { cursor: crosshair; touch-action: none; }
        .decision-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            border-width: 2px;
        }
        
        /* Ẩn dropdown menu (cho nút 3 chấm) */
        .camera-menu { display: none; }
        .group:hover .camera-menu,
        .group:focus-within .camera-menu { display: block; }
        
        /* Wrapper cho thumbnail 16:9 */
        .camera-angle-wrapper {
            aspect-ratio: 16 / 9;
            background-color: #000;
            transition: transform 0.1s ease-out; /* Hiệu ứng đàn hồi */
        }
        .camera-angle-video, .camera-angle-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Canvas cho AI detection */
        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Cho phép click xuyên qua */
        }
        
        /* SỬA LỖI: Quay về CSS cho Material ICONS Round */
        .material-icons-round {
            font-family: 'Material Icons Round';
            font-weight: normal;
            font-style: normal;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: 'liga';
            user-select: none; /* Ngăn chọn text icon */
        }

        .btn-icon {
            font-size: 1.25rem; /* 20px */
            line-height: 1;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-icon-sm {
            font-size: 1rem; /* 16px */
            line-height: 1;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .menu-icon {
            font-size: 1.25rem; /* 20px */
            margin-right: 0.5rem; /* mr-2 */
        }
        
        /* Đảm bảo text input trong modal có màu trắng */
        input::placeholder { color: #9ca3af; /* gray-400 */ }
        input { color: white; }
        select { color: white; background-image: none; }
        select option { color: black; background: white; }
        
        /* Hiệu ứng đàn hồi cho Modal */
        .modal {
            transition: opacity 300ms ease-out, transform 300ms cubic-bezier(0.18, 0.89, 0.32, 1.28); /* ease-out-back */
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: flex; 
        }
        .modal.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; 
        }
        .modal:not(.open) {
             visibility: hidden;
        }
        
        /* Menu popup (cho Bảng điều khiển) */
        .popup-menu {
            transition: opacity 200ms ease-out, transform 200ms ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            visibility: hidden;
            z-index: 100; 
        }
        /* Vị trí menu con */
        .popup-menu .popup-menu {
            bottom: 0;
            right: 100%;
            margin-right: 0.5rem; /* mr-2 */
            transform: translateY(0) translateX(10px); /* Dịch sang phải */
        }
        .popup-menu.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }
        .popup-menu .popup-menu.open {
            transform: translateY(0) translateX(0);
        }
        
        /* Tooltip (Chú thích) */
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            position: absolute;
            z-index: 101; 
            bottom: 125%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Container chính (Nội dung) -->
    <div class="p-4 flex-grow flex flex-col overflow-y-auto">
        
        <main class="flex flex-col lg:flex-row gap-6">
            
            <div class="lg:w-2/3 flex flex-col gap-5">
                <!-- Bảng Màn hình chính -->
                <div class="glass-panel-rect p-5 flex-grow flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Màn hình chính</h2>
                    
                    <!-- Màn hình xem lại (CÓ BẢNG ĐIỀU KHIỂN BÊN TRONG) -->
                    <div id="reviewScreen" class="relative w-full aspect-video bg-black rounded-md overflow-hidden">
                        
                        <div id="singleView" class="w-full h-full">
                            <img id="mainVideoFeedImage" 
                                 src="https://placehold.co/1920x1080/22c55e/ffffff?text=Sân+cỏ" 
                                 alt="Video feed image" 
                                 class="w-full h-full object-cover">
                            <video id="mainVideoFeedVideo"
                                   alt="Video feed video"
                                   class="w-full h-full object-cover hidden"
                                   autoplay muted playsinline></video>
                            <canvas id="reviewCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                            <canvas id="detectionCanvas" class="absolute top-0 left-0"></canvas>
                        </div>
                        
                        <div id="gridView" class="w-full h-full grid grid-cols-2 gap-1 hidden">
                            <!-- Các ô lưới sẽ được thêm bằng JS -->
                        </div>

                        <!-- BẢNG ĐIỀU KHIỂN MỚI (Nằm BÊN TRONG, ĐÈ LÊN) -->
                        
                        <!-- Cụm bên TRÁI -->
                        <div class="absolute z-10 bottom-2 left-2 p-2 glass-panel">
                            <div class="flex items-center gap-2">
                                <button id="btnPrevFrame" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">skip_previous</span>
                                    <span class="tooltip-text">Frame trước</span>
                                </button>
                                <button id="btnBack3s" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">fast_rewind</span>
                                    <span class="tooltip-text">Lùi 3s</span>
                                </button>
                                <button id="btnTogglePlay" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span id="playPauseIcon" class="material-icons-round btn-icon">play_arrow</span>
                                    <span id="playPauseTooltip" class="tooltip-text">Phát</span>
                                </button>
                                <button id="btnForward3s" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">fast_forward</span>
                                    <span class="tooltip-text">Tới 3s</span>
                                </button>
                                <button id="btnNextFrame" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">skip_next</span>
                                    <span class="tooltip-text">Frame sau</span>
                                </button>
                                <div class="text-sm font-mono ml-2 hidden md:block" title="Thời gian">
                                    00:00 / 00:00
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cụm bên PHẢI -->
                        <div class="absolute z-10 bottom-2 right-2 p-2 glass-panel">
                            <div class="flex items-center gap-2">
                                <!-- Nút Bố cục (Mới) -->
                                <div class="relative tooltip">
                                    <button id="btnOpenLayoutMenu" class="glass-button text-white font-bold p-2 transition duration-200">
                                        <span class="material-icons-round btn-icon">view_quilt</span>
                                    </button>
                                    <span class="tooltip-text">Bố cục</span>
                                    <!-- Menu Bố cục -->
                                    <div id="layoutMenu" class="popup-menu absolute bottom-full right-0 mb-2 w-48 glass-panel-rect rounded-lg shadow-lg p-4">
                                        <label for="layoutRadioSingle" class="flex items-center gap-2 mb-2 p-2 rounded-lg hover:bg-white/10 cursor-pointer">
                                            <input type="radio" id="layoutRadioSingle" name="layoutType" value="single" class="text-blue-500 focus:ring-blue-400" checked>
                                            Đơn
                                        </label>
                                        <label for="layoutRadioGrid" class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/10 cursor-pointer">
                                            <input type="radio" id="layoutRadioGrid" name="layoutType" value="grid" class="text-blue-500 focus:ring-blue-400">
                                            Xếp kề
                                        </label>
                                        <input type="number" id="gridInput" class="glass-button glass-button-rect text-white text-sm rounded-lg py-2 px-3 w-full mt-2 hidden" placeholder="Số ô (ví dụ: 4)" value="4">
                                    </div>
                                </div>
                                
                                <button id="btnScreenshot" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">photo_camera</span>
                                    <span class="tooltip-text">Chụp ảnh</span>
                                </button>
                                <button id="btnToggleDetection" class="glass-button text-white font-bold p-2 transition duration-200 tooltip purple">
                                    <span id="detectIcon" class="material-icons-round btn-icon">auto_awesome</span>
                                    <span class="tooltip-text">Bật/Tắt Detect</span>
                                </button>
                                
                                <!-- Nút More (Mới) -->
                                <div class="relative tooltip">
                                    <button id="btnOpenMoreMenu" class="glass-button text-white font-bold p-2 transition duration-200">
                                        <span class="material-icons-round btn-icon">more_vert</span>
                                    </button>
                                    <span class="tooltip-text">Thêm</span>
                                    <!-- Menu More -->
                                    <div id="moreMenu" class="popup-menu absolute bottom-full right-0 mb-2 w-56 glass-panel-rect rounded-lg shadow-lg overflow-hidden">
                                        <!-- Menu Tốc độ (con) -->
                                        <div id="speedMenu" class="popup-menu absolute w-48 glass-panel-rect rounded-lg shadow-lg p-3">
                                            <span class="text-sm px-1">Tốc độ</span>
                                            <div class="grid grid-cols-4 gap-1 mt-2">
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="0.25">0.25</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="0.5">0.5</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="0.75">0.75</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded active bg-blue-600" data-speed="1">1x</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="1.25">1.25</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="1.5">1.5</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="1.75">1.75</button>
                                                <button class="btn-speed glass-button glass-button-rect text-xs p-1 rounded" data-speed="2">2x</button>
                                            </div>
                                        </div>
                                        <button id="btnOpenSpeedMenu" class="relative w-full text-left px-4 py-3 hover:bg-white/10 transition flex items-center justify-between gap-2">
                                            <span class="flex items-center gap-2"><span class="material-icons-round">speed</span> Tốc độ phát</span>
                                            <span class="material-icons-round">chevron_right</span>
                                        </button>
                                        <button class="w-full text-left px-4 py-3 hover:bg-white/10 transition flex items-center gap-2">
                                            <span class="material-icons-round">high_quality</span> Chất lượng...
                                        </button>
                                    </div>
                                </div>
                                
                                <button id="btnToggleFullscreen" class="glass-button text-white font-bold p-2 transition duration-200 tooltip">
                                    <span id="iconFullscreen" class="material-icons-round btn-icon">fullscreen</span>
                                    <span id="iconExitFullscreen" class="material-icons-round btn-icon hidden">fullscreen_exit</span>
                                    <span class="tooltip-text">Toàn màn hình</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BẢNG ĐIỀU KHIỂN VẼ VẠCH (Riêng biệt, nằm BÊN DƯỚI) -->
                    <div class="mt-4 p-4 glass-panel-rect rounded-lg">
                        <div class="flex items-center gap-2 justify-center">
                            <span class="text-sm font-medium hidden lg:inline mr-2">Vẽ vạch:</span>
                            <button id="btnDrawRedLine" class="glass-button glass-button-rect text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                TĐ
                                <span class="tooltip-text">Vạch Tấn công</span>
                            </button>
                            <button id="btnDrawBlueLine" class="glass-button glass-button-rect text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                HV
                                <span class="tooltip-text">Vạch Hậu vệ</span>
                            </button>
                            <button id="btnClearLines" class="glass-button glass-button-rect text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                Xóa
                                <span class="tooltip-text">Xóa vạch</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cột bên phải: Các góc máy & Quyết định -->
            <div class="lg:w-1/3 flex flex-col gap-6">
                
                <!-- Các góc máy quay -->
                <div class="glass-panel-rect p-4">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h2 class="text-2xl font-semibold">Góc máy quay</h2>
                        <button id="btnOpenAddCameraModal" class="glass-button text-white font-bold w-10 h-10 rounded-full flex items-center justify-center tooltip">
                            <span class="material-icons-round btn-icon-sm">add</span>
                            <span class="tooltip-text">Thêm camera</span>
                        </button>
                    </div>
                    <!-- Thanh cuộn ngang chứa các góc máy -->
                    <div id="cameraAngleContainer" class="flex overflow-x-auto gap-3 pb-2">
                        <!-- Camera 1 -->
                        <div id="cam-init-1" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/22c55e/ffffff?text=Main+Cam" 
                                 alt="Main Cam" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/22c55e/ffffff?text=Main+Cam">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Main Cam</span>
                            <!-- Nút 3 chấm -->
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Tùy chọn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <!-- Menu tùy chọn -->
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    Đổi tên
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    Xóa
                                </a>
                            </div>
                        </div>
                        <!-- Camera 2 -->
                        <div id="cam-init-2" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/eab308/ffffff?text=Góc+16m50" 
                                 alt="Góc 16m50" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/eab308/ffffff?text=Góc+16m50">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Góc 16m50</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Tùy chọn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    Đổi tên
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    Xóa
                                </a>
                            </div>
                        </div>
                        <!-- Camera 3 -->
                        <div id="cam-init-3" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/ef4444/ffffff?text=Sau+gôn+A" 
                                 alt="Sau gôn A" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/ef4444/ffffff?text=Sau+gôn+A">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau gôn A</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Tùy chọn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    Đổi tên
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    Xóa
                                </a>
                            </div>
                        </div>
                        <!-- Camera 4 -->
                        <div id="cam-init-4" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/3b82f6/ffffff?text=Sau+gôn+B" 
                                 alt="Sau gôn B" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/3b82f6/ffffff?text=Sau+gôn+B">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau gôn B</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Tùy chọn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    Đổi tên
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    Xóa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quyết định của VAR -->
                <div class="glass-panel-rect p-4 lg:sticky top-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Ra quyết định</h2>
                    <div class="space-y-3">
                        <button class="decision-btn glass-button glass-button-rect success w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="BÀN THẮNG HỢP LỆ">
                            <span class="material-icons-round menu-icon">check_circle</span> Bàn thắng
                        </button>
                        <button class="decision-btn glass-button glass-button-rect danger w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="KHÔNG CÓ BÀN THẮNG (Việt vị)">
                            <span class="material-icons-round menu-icon">cancel</span> Không có bàn thắng
                        </button>
                        <button class="decision-btn glass-button glass-button-rect warning w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="THẺ VÀNG">
                            <span class="material-icons-round menu-icon">rectangle</span> Thẻ vàng
                        </button>
                        <button class="decision-btn glass-button glass-button-rect danger w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="THẺ ĐỎ">
                            <span class="material-icons-round menu-icon">rectangle</span> Thẻ đỏ
                        </button>
                        <button class="decision-btn glass-button glass-button-rect info w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="PENALTY">
                            <span class="material-icons-round menu-icon">sports_soccer</span> Penalty
                        </button>
                    </div>
                    <div id="finalDecisionBox" class="mt-4 p-4 bg-gray-900 bg-opacity-50 rounded-lg text-center hidden">
                        <h3 class="text-lg font-bold text-yellow-400">QUYẾT ĐỊNH CUỐI CÙNG</h3>
                        <p id="decisionText" class="text-2xl font-bold mt-2"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer cố định -->
    <footer class="w-full bg-gray-950 text-gray-400 p-2 border-t border-gray-800 flex-shrink-0">
        <div class="px-4 flex justify-between items-center">
            <div id="clockDate" class="text-sm font-medium">Đang tải...</div>
            <div id="pairing-section" class="flex items-center gap-2">
                <div id="pairing-default-view" class="flex items-center gap-2">
                    <button id="btnGetPairCode" class="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition tooltip">
                        <span class="material-icons-round btn-icon-sm">add_link</span>
                        <span class="hidden md:inline">LẤY MÃ GHÉP ĐÔI</span>
                        <span class="tooltip-text">Lấy mã ghép đôi</span>
                    </button>
                </div>
                <!-- SỬA LỖI: Bỏ đồng hồ đếm ngược -->
                <div id="pairing-code-view" class="hidden items-center gap-3">
                    <span class="text-sm">MÃ PHÒNG (CỐ ĐỊNH):</span>
                    <span class="text-lg font-bold tracking-widest text-yellow-400" id="pairCodeDisplay"></span>
                </div>
            </div>
        </div>
    </footer>
    
    
    <!-- === CÁC CỬA SỔ POPUP (MODAL) === -->
    
    <div id="renameModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel-rect rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Đổi tên Camera</h3>
            <input type="text" id="renameInput" class="w-full glass-button glass-button-rect text-white rounded-lg px-4 py-2" placeholder="Nhập tên mới...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelRename" class="glass-button glass-button-rect text-white font-bold py-2 px-4 rounded-lg transition">Hủy</button>
                <button type="button" id="btnSaveRename" class="glass-button glass-button-rect info text-white font-bold py-2 px-4 rounded-lg transition">Lưu</button>
            </div>
        </div>
    </div>
    
    <div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel-rect rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Xác nhận Xóa</h3>
            <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa góc máy quay này không?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelDelete" class="glass-button glass-button-rect text-white font-bold py-2 px-4 rounded-lg transition">Hủy</button>
                <button type="button" id="btnConfirmDelete" class="glass-button glass-button-rect danger text-white font-bold py-2 px-4 rounded-lg transition">OK, Xóa</button>
            </div>
        </div>
    </div>

    <div id="addCameraModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel-rect rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Thêm Camera</h3>
            <input type="text" id="addCameraNameInput" class="w-full glass-button glass-button-rect text-white rounded-lg px-4 py-2" placeholder="Nhập tên camera mới...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelAddCamera" class="glass-button glass-button-rect text-white font-bold py-2 px-4 rounded-lg transition">Hủy</button>
                <button type="button" id="btnConfirmAddCamera" class="glass-button glass-button-rect info text-white font-bold py-2 px-4 rounded-lg transition">Thêm</button>
            </div>
        </div>
    </div>
    
    <div id="pairingModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel-rect rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Yêu cầu Ghép đôi</h3>
            <p class="text-gray-300 mb-6">Một thiết bị (ID: <span id="incomingPeerId" class="font-bold">...</span>) đang cố gắng kết nối. Bạn có chấp nhận không?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnRejectPairing" class="glass-button glass-button-rect text-white font-bold py-2 px-4 rounded-lg transition">Không phải</button>
                <button type="button" id="btnAcceptPairing" class="glass-button glass-button-rect success text-white font-bold py-2 px-4 rounded-lg transition">Phải</button>
            </div>
        </div>
    </div>
    
    <div id="selectCameraSlotModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel-rect rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Chọn Vị trí Camera</h3>
            <p class="text-gray-300 mb-4">Đặt camera mới này vào vị trí nào?</p>
            <select id="cameraSlotSelect" class="w-full glass-button glass-button-rect text-white rounded-lg px-4 py-2 mb-4">
                <option value="new" class="text-black">-- Thêm làm camera mới --</option>
            </select>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelSelectSlot" class="glass-button glass-button-rect text-white font-bold py-2 px-4 rounded-lg transition">Hủy</button>
                <button type="button" id="btnConfirmSelectSlot" class="glass-button glass-button-rect info text-white font-bold py-2 px-4 rounded-lg transition">Xác nhận</button>
            </div>
        </div>
    </div>
    
    
    <!-- ================================== -->
    <!-- === SCRIPT CHÍNH CỦA ỨNG DỤNG === -->
    <!-- ================================== -->
    <script type="module">
        // Biến toàn cục cho PeerJS
        let peer = null;
        let currentPeerId = null;
        let incomingConnection = null; 
        let incomingCall = null; 
        
        // Biến toàn cục cho AI
        let faceModel = null;
        let objectModel = null;
        let isDetectionRunning = false;
        let detectionInterval = null;
        
        // Biến toàn cục cho Camera Modals
        let activeCameraElement = null; 

        // --- CÁC HÀM TIỆN ÍCH ---
        
        async function playVideoSafe(videoElement) {
            if (!videoElement) return;
            videoElement.muted = true;
            try {
                await videoElement.play();
            } catch (error) {
                if (error.name !== 'AbortError' && !error.message.includes('interrupted')) {
                    console.error(`Lỗi phát video (${videoElement.id || 'N/A'}):`, error.message);
                }
            }
        }
        
        function showModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('modal:not(.open)');
                requestAnimationFrame(() => {
                    modalElement.classList.add('open');
                });
            }
        }

        function hideModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('open');
                setTimeout(() => {
                    modalElement.classList.add('modal:not(.open)');
                }, 300);
            }
        }

        function togglePopupMenu(menuElement) {
            if (!menuElement) return;
            const isOpen = menuElement.classList.contains('open');
            hideAllPopups(); // Luôn ẩn tất cả trước
            if (!isOpen) {
                menuElement.classList.add('open');
            }
        }
        
        function hideAllPopups(exceptMenu = null) {
            document.querySelectorAll('.popup-menu').forEach(menu => {
                if (menu !== exceptMenu && !menu.contains(exceptMenu)) {
                    menu.classList.remove('open');
                }
            });
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                hideAllPopups();
            }
            if (!e.target.closest('.group')) {
                document.querySelectorAll('.camera-menu').forEach(menu => menu.style.display = 'none');
            }
        });


        // --- HÀM KHỞI TẠO CHÍNH ---
        
        async function main() {
            // Khởi tạo các biến DOM
            const mainVideoFeedImage = document.getElementById('mainVideoFeedImage');
            const mainVideoFeedVideo = document.getElementById('mainVideoFeedVideo');
            const cameraAngleContainer = document.getElementById('cameraAngleContainer');
            const decisionButtons = document.querySelectorAll('.decision-btn');
            const finalDecisionBox = document.getElementById('finalDecisionBox');
            const decisionText = document.getElementById('decisionText');
            
            // DOM Bảng điều khiển MỚI
            const btnPrevFrame = document.getElementById('btnPrevFrame');
            const btnBack3s = document.getElementById('btnBack3s');
            const btnTogglePlay = document.getElementById('btnTogglePlay');
            const playPauseIcon = document.getElementById('playPauseIcon');
            const playPauseTooltip = document.getElementById('playPauseTooltip'); 
            const btnForward3s = document.getElementById('btnForward3s');
            const btnNextFrame = document.getElementById('btnNextFrame');
            
            const btnDrawRedLine = document.getElementById('btnDrawRedLine');
            const btnDrawBlueLine = document.getElementById('btnDrawBlueLine');
            const btnClearLines = document.getElementById('btnClearLines');

            const btnOpenLayoutMenu = document.getElementById('btnOpenLayoutMenu');
            const layoutMenu = document.getElementById('layoutMenu');
            const layoutRadioSingle = document.getElementById('layoutRadioSingle');
            const layoutRadioGrid = document.getElementById('layoutRadioGrid');
            const gridInput = document.getElementById('gridInput');
            
            const btnScreenshot = document.getElementById('btnScreenshot');
            const btnToggleDetection = document.getElementById('btnToggleDetection');
            
            const btnOpenMoreMenu = document.getElementById('btnOpenMoreMenu');
            const moreMenu = document.getElementById('moreMenu');
            const btnOpenSpeedMenu = document.getElementById('btnOpenSpeedMenu');
            const speedMenu = document.getElementById('speedMenu');
            const speedButtons = document.querySelectorAll('.btn-speed');
            
            const btnToggleFullscreen = document.getElementById('btnToggleFullscreen');
            const iconFullscreen = document.getElementById('iconFullscreen');
            const iconExitFullscreen = document.getElementById('iconExitFullscreen');
            
            // DOM Canvas
            const canvas = document.getElementById('reviewCanvas');
            const ctx = canvas.getContext('2d');
            const detectionCanvas = document.getElementById('detectionCanvas');
            const detCtx = detectionCanvas.getContext('2d');
            
            // DOM Chế độ xem
            const singleView = document.getElementById('singleView');
            const gridView = document.getElementById('gridView');
            
            // Đồng hồ
            const clockDateElement = document.getElementById('clockDate');

            // Các nút Camera Modal
            const btnOpenAddCameraModal = document.getElementById('btnOpenAddCameraModal');
            const addCameraModal = document.getElementById('addCameraModal');
            const btnCancelAddCamera = document.getElementById('btnCancelAddCamera');
            const btnConfirmAddCamera = document.getElementById('btnConfirmAddCamera');
            const addCameraNameInput = document.getElementById('addCameraNameInput');

            const renameModal = document.getElementById('renameModal');
            const btnCancelRename = document.getElementById('btnCancelRename');
            const btnSaveRename = document.getElementById('btnSaveRename');
            const renameInput = document.getElementById('renameInput');

            const deleteModal = document.getElementById('deleteModal');
            const btnCancelDelete = document.getElementById('btnCancelDelete');
            const btnConfirmDelete = document.getElementById('btnConfirmDelete');

            // Các nút Pairing Modal
            const btnGetPairCode = document.getElementById('btnGetPairCode');
            const pairingDefaultView = document.getElementById('pairing-default-view');
            const pairingCodeView = document.getElementById('pairing-code-view');
            const pairCodeDisplay = document.getElementById('pairCodeDisplay');
            const pairingModal = document.getElementById('pairingModal');
            const btnRejectPairing = document.getElementById('btnRejectPairing');
            const btnAcceptPairing = document.getElementById('btnAcceptPairing');
            const incomingPeerId = document.getElementById('incomingPeerId');

            // Các nút Select Slot Modal
            const selectCameraSlotModal = document.getElementById('selectCameraSlotModal');
            const cameraSlotSelect = document.getElementById('cameraSlotSelect');
            const btnCancelSelectSlot = document.getElementById('btnCancelSelectSlot');
            const btnConfirmSelectSlot = document.getElementById('btnConfirmSelectSlot');
            
            // Ẩn tất cả modal khi bắt đầu
            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('modal:not(.open)'));

            let isPlaying = false;
            let currentLineColor = 'red';
            let isDrawing = false;
            let startX, startY;
            const incidentImageSrc = 'https://placehold.co/1920x1080/db2777/ffffff?text=Tình+huống+Việt+vị';
            
            // --- 0. KHỞI TẠO ĐỒNG HỒ ---
            function updateClock() {
                const now = new Date();
                const options = {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour12: false
                };
                if (clockDateElement) {
                    clockDateElement.textContent = now.toLocaleDateString('vi-VN', options);
                }
            }
            setInterval(updateClock, 1000);
            updateClock();

            // --- 1. HÀM VẼ VẠCH (CANVAS) ---
            function resizeCanvas(sourceElement) {
                if (!sourceElement || !canvas) return;
                
                requestAnimationFrame(() => {
                    const reviewScreen = document.getElementById('reviewScreen');
                    if (!reviewScreen) return;
                    
                    const rect = reviewScreen.getBoundingClientRect();
                    
                    if (rect.width === 0 || rect.height === 0) return;
                    
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    canvas.style.width = `${rect.width}px`;
                    canvas.style.height = `${rect.height}px`;
                    
                    detectionCanvas.width = rect.width;
                    detectionCanvas.height = rect.height;
                    detectionCanvas.style.width = `${rect.width}px`;
                    detectionCanvas.style.height = `${rect.height}px`;
                });
            }

            window.addEventListener('resize', () => {
                const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                resizeCanvas(currentFeed);
            });
            mainVideoFeedImage.onload = () => resizeCanvas(mainVideoFeedImage);
            mainVideoFeedVideo.onloadedmetadata = () => resizeCanvas(mainVideoFeedVideo);
            resizeCanvas(mainVideoFeedImage);


            function clearLines() {
                if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function getMousePos(evt) {
                const reviewRect = document.getElementById('reviewScreen').getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const scaleX = canvas.width / canvasRect.width;
                const scaleY = canvas.height / canvasRect.height;
                
                let clientX = evt.clientX;
                let clientY = evt.clientY;

                if (evt.touches && evt.touches.length > 0) {
                    clientX = evt.touches[0].clientX;
                    clientY = evt.touches[0].clientY;
                }

                return {
                    x: (clientX - canvasRect.left) * scaleX,
                    y: (clientY - canvasRect.top) * scaleY
                };
            }

            function startDrawing(e) {
                if (e.target.closest('.glass-panel')) return; 
                e.preventDefault();
                if (singleView.classList.contains('hidden')) return;
                isDrawing = true;
                const pos = getMousePos(e);
                startX = pos.x;
                startY = pos.y;
            }

            function draw(e) {
                if (!isDrawing || singleView.classList.contains('hidden')) return;
                e.preventDefault();
                clearLines(); 
                const pos = getMousePos(e);
                ctx.beginPath();
                ctx.strokeStyle = currentLineColor;
                ctx.lineWidth = 4;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.moveTo(startX, startY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stopDrawing(e) {
                if (!isDrawing) return;
                isDrawing = false;
            }

            if (canvas) {
                const reviewScreen = document.getElementById('reviewScreen');
                reviewScreen.addEventListener('mousedown', startDrawing);
                reviewScreen.addEventListener('touchstart', startDrawing);
                
                window.addEventListener('mousemove', draw);
                window.addEventListener('touchmove', draw);
                window.addEventListener('mouseup', stopDrawing);
                window.addEventListener('touchend', stopDrawing);
                window.addEventListener('touchcancel', stopDrawing);
            }
            
            if (btnDrawRedLine) btnDrawRedLine.addEventListener('click', () => currentLineColor = '#ef4444');
            if (btnDrawBlueLine) btnDrawBlueLine.addEventListener('click', () => currentLineColor = '#3b82f6');
            if (btnClearLines) btnClearLines.addEventListener('click', clearLines);

            // --- 2. HÀM ĐIỀU KHIỂN CHÍNH ---

            function setupCameraAngleClick(camElement) {
                camElement.addEventListener('click', async (e) => {
                    if (e.target.closest('.btn-camera-options') || e.target.closest('.camera-menu')) return;
                    if (layoutRadioGrid.checked) layoutRadioSingle.click(); 
                    
                    clearLines(); 
                    
                    const imgSrc = camElement.dataset.src;
                    const videoStream = camElement.videoStream;

                    if (videoStream) {
                        mainVideoFeedImage.classList.add('hidden');
                        mainVideoFeedVideo.classList.remove('hidden');
                        mainVideoFeedVideo.srcObject = videoStream;
                        await playVideoSafe(mainVideoFeedVideo);
                        resizeCanvas(mainVideoFeedVideo);
                    } else if (imgSrc) {
                        mainVideoFeedImage.classList.remove('hidden');
                        mainVideoFeedVideo.classList.add('hidden');
                        if (mainVideoFeedVideo.srcObject) {
                            mainVideoFeedVideo.srcObject.getTracks().forEach(track => track.stop());
                        }
                        mainVideoFeedVideo.srcObject = null;
                        mainVideoFeedImage.src = imgSrc;
                        resizeCanvas(mainVideoFeedImage);
                    }
                });
            }
            
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraAngleClick);

            if (btnTogglePlay) {
                btnTogglePlay.addEventListener('click', async () => {
                    isPlaying = !isPlaying;
                    const currentFeed = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;
                    
                    // SỬA LỖI: Quay về logic cũ
                    if (isPlaying) {
                        if (playPauseIcon) playPauseIcon.textContent = 'pause';
                        if (playPauseTooltip) playPauseTooltip.textContent = 'Dừng';
                        if (currentFeed) await playVideoSafe(currentFeed);
                    } else {
                        if (playPauseIcon) playPauseIcon.textContent = 'play_arrow';
                        if (playPauseTooltip) playPauseTooltip.textContent = 'Phát';
                        if (currentFeed) currentFeed.pause();
                    }
                });
            }

            decisionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const decision = btn.dataset.decision;
                    if (decisionText) decisionText.textContent = decision;
                    if (finalDecisionBox) finalDecisionBox.classList.remove('hidden');
                    decisionButtons.forEach(b => b.classList.remove('active', 'border-yellow-400', 'border-2'));
                    btn.classList.add('active', 'border-yellow-400', 'border-2');
                });
            });

            // --- 3. HÀM QUẢN LÝ BỐ CỤC (Layout MỚI) ---
            
            if (btnOpenLayoutMenu) {
                btnOpenLayoutMenu.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    togglePopupMenu(layoutMenu);
                });
            }
            
            if (layoutRadioSingle) {
                layoutRadioSingle.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.add('hidden');
                    if (singleView) singleView.classList.remove('hidden');
                    if (gridView) gridView.classList.add('hidden');
                    const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                    resizeCanvas(currentFeed);
                    hideAllPopups();
                });
            }

            if (layoutRadioGrid) {
                layoutRadioGrid.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.remove('hidden');
                    if (singleView) singleView.classList.add('hidden');
                    if (gridView) gridView.classList.remove('hidden');
                    updateGridView();
                });
            }

            function updateGridView() {
                if (!gridView || !gridInput) return;
                
                const count = parseInt(gridInput.value) || 4;
                const cols = Math.ceil(Math.sqrt(count));
                gridView.className = `w-full h-full grid gap-1 grid-cols-${cols}`;
                gridView.innerHTML = '';
                
                const sources = Array.from(document.querySelectorAll('.camera-angle-wrapper'));
                
                for (let i = 0; i < count; i++) {
                    const sourceElement = sources[i % sources.length]; 
                    if (!sourceElement) continue;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'aspect-video bg-black rounded-md overflow-hidden'; 

                    if (sourceElement.videoStream) {
                        const videoElement = document.createElement('video');
                        videoElement.srcObject = sourceElement.videoStream;
                        videoElement.className = 'w-full h-full object-cover';
                        videoElement.autoplay = true;
                        videoElement.muted = true;
                        videoElement.playsinline = true;
                        wrapper.appendChild(videoElement);
                        gridView.appendChild(wrapper);
                        playVideoSafe(videoElement);
                    } else if (sourceElement.dataset.src) {
                        const imgElement = document.createElement('img');
                        imgElement.src = sourceElement.dataset.src;
                        imgElement.alt = `Camera ${i + 1}`;
                        imgElement.className = 'w-full h-full object-cover';
                        wrapper.appendChild(imgElement);
                        gridView.appendChild(wrapper);
                    }
                }
            }
            if (gridInput) gridInput.addEventListener('input', updateGridView);

            // --- 3.5. HÀM QUẢN LÝ MENU "MORE" ---

            if (btnOpenMoreMenu) {
                btnOpenMoreMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePopupMenu(moreMenu);
                });
            }
            
            if (btnOpenSpeedMenu) {
                btnOpenSpeedMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    hideAllPopups(moreMenu); 
                    togglePopupMenu(speedMenu);
                });
            }
            
            speedButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const speed = parseFloat(e.currentTarget.dataset.speed);
                    speedButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                    e.currentTarget.classList.add('active', 'bg-blue-600');
                    mainVideoFeedVideo.playbackRate = speed;
                    hideAllPopups();
                });
            });
            
            if (btnToggleFullscreen) {
                btnToggleFullscreen.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                });
                document.addEventListener('fullscreenchange', () => {
                    // SỬA LỖI: Quay về logic cũ
                    const icon = btnToggleFullscreen.querySelector('.material-icons-round');
                    if (!document.fullscreenElement) {
                        if (icon) icon.textContent = 'fullscreen';
                    } else {
                        if (icon) icon.textContent = 'fullscreen_exit';
                    }
                });
            }

            // --- 4. HÀM QUẢN LÝ CAMERA (Thêm/Sửa/Xóa) ---

            function createNewCameraElement(id, name, imgSrc, stream = null) {
                const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                const placeholderImg = `https://placehold.co/300x200/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;
                const placeholderSrc = `https://placehold.co/1920x1080/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;

                const wrapper = document.createElement('div');
                wrapper.id = id;
                wrapper.className = "camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition";
                
                const img = document.createElement('img');
                img.className = "camera-angle camera-angle-image w-full h-full object-cover";
                img.alt = name;
                
                const video = document.createElement('video');
                video.className = "camera-angle-video hidden";
                video.autoplay = true;
                video.muted = true;
                video.playsinline = true;

                if (stream) {
                    wrapper.videoStream = stream; 
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    img.classList.add('hidden');
                } else {
                    img.src = imgSrc || placeholderImg;
                    wrapper.dataset.src = imgSrc || placeholderSrc;
                    video.classList.add('hidden');
                    img.classList.remove('hidden');
                }

                wrapper.innerHTML = `
                    ${img.outerHTML}
                    ${video.outerHTML}
                    <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">${name}</span>
                    <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Tùy chọn">
                        <span class="material-icons-round text-lg">more_vert</span>
                    </button>
                    <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                        <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                            <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                            Đổi tên
                        </a>
                        <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                            <span class="material-icons-round menu-icon text-red-600">delete</span>
                            Xóa
                        </a>
                    </div>
                `;
                
                setupCameraAngleClick(wrapper);
                setupCameraOptionEvents(wrapper);
                
                if (stream) {
                    playVideoSafe(wrapper.querySelector('.camera-angle-video'));
                }
                
                return wrapper;
            }

            function setupCameraOptionEvents(cameraElement) {
                const btnOptions = cameraElement.querySelector('.btn-camera-options');
                const btnRename = cameraElement.querySelector('.btn-rename-camera');
                const btnDelete = cameraElement.querySelector('.btn-delete-camera');
                const menu = cameraElement.querySelector('.camera-menu');

                if (btnOptions) {
                    btnOptions.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                if (btnRename) {
                    btnRename.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement;
                        if (renameInput) renameInput.value = cameraElement.querySelector('.camera-name').textContent;
                        showModal(renameModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
                
                if (btnDelete) {
                    btnDelete.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement;
                        showModal(deleteModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
            }
            
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraOptionEvents);
            
            if (btnOpenAddCameraModal) btnOpenAddCameraModal.addEventListener('click', () => showModal(addCameraModal));
            if (btnCancelAddCamera) btnCancelAddCamera.addEventListener('click', () => hideModal(addCameraModal));
            if (btnConfirmAddCamera) {
                btnConfirmAddCamera.addEventListener('click', () => {
                    const name = addCameraNameInput.value.trim();
                    if (name) {
                        const newId = `cam-${Date.now()}`;
                        const newCam = createNewCameraElement(newId, name, null);
                        if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                        addCameraNameInput.value = '';
                        hideModal(addCameraModal);
                    }
                });
            }
            
            if (btnCancelRename) btnCancelRename.addEventListener('click', () => hideModal(renameModal));
            if (btnSaveRename) {
                btnSaveRename.addEventListener('click', () => {
                    const newName = renameInput.value.trim();
                    if (newName && activeCameraElement) {
                        const nameSpan = activeCameraElement.querySelector('.camera-name');
                        if (nameSpan) nameSpan.textContent = newName;
                        const img = activeCameraElement.querySelector('.camera-angle-image');
                        if (img) img.alt = newName;
                        if (activeCameraElement.dataset.src) {
                            try {
                                const oldSrc = new URL(activeCameraElement.dataset.src);
                                oldSrc.searchParams.set('text', newName);
                                activeCameraElement.dataset.src = oldSrc.href;
                                const thumbImg = activeCameraElement.querySelector('.camera-angle-image');
                                if (thumbImg) {
                                    const oldThumbSrc = new URL(thumbImg.src);
                                    oldThumbSrc.searchParams.set('text', newName);
                                    thumbImg.src = oldThumbSrc.href;
                                }
                            } catch(e) {
                                console.warn("Không thể cập nhật text của placeholder image", e);
                            }
                        }
                    }
                    hideModal(renameModal);
                    activeCameraElement = null;
                });
            }

            if (btnCancelDelete) btnCancelDelete.addEventListener('click', () => hideModal(deleteModal));
            if (btnConfirmDelete) {
                btnConfirmDelete.addEventListener('click', () => {
                    if (activeCameraElement) {
                        if (activeCameraElement.videoStream) {
                            activeCameraElement.videoStream.getTracks().forEach(track => track.stop());
                        }
                        activeCameraElement.remove();
                    }
                    hideModal(deleteModal);
                    activeCameraElement = null;
                });
            }

            // --- 5. HÀM QUẢN LÝ PEERJS (WebRTC) ---
            
            function initializePeer(id) {
                if (peer) peer.destroy();
                try {
                    peer = new Peer(id, { debug: 2 });
                } catch (e) {
                    console.error("Không thể khởi tạo PeerJS. PeerJS có được tải không?", e);
                    return;
                }
                peer.on('open', (id) => console.log('PeerJS đã sẵn sàng. ID của tôi là:', id));
                peer.on('error', (err) => {
                    console.error('Lỗi PeerJS:', err);
                    if (err.type === 'peer-unavailable') {
                        alert('Không tìm thấy mã ghép đôi. Vui lòng thử lại.');
                        resetPairing();
                    }
                });
                peer.on('connection', (conn) => {
                    console.log('Phát hiện kết nối đến:', conn.peer);
                    incomingConnection = conn;
                    if (incomingPeerId) incomingPeerId.textContent = conn.peer;
                    showModal(pairingModal);
                });
                peer.on('call', (call) => {
                    console.log('Nhận được cuộc gọi video từ:', call.peer);
                    if (!incomingConnection || incomingConnection.peer !== call.peer) {
                         console.log("Cuộc gọi đến trước khi xác nhận. Lưu lại.");
                         incomingCall = call;
                         if (incomingPeerId) incomingPeerId.textContent = call.peer;
                         showModal(pairingModal);
                         return; 
                    }
                    openSelectSlotModal(call);
                });
            }
            
            function openSelectSlotModal(call) {
                incomingCall = call; 
                if (cameraSlotSelect) {
                    cameraSlotSelect.innerHTML = '<option value="new" class="text-black">-- Thêm làm camera mới --</option>';
                    document.querySelectorAll('.camera-angle-wrapper').forEach(cam => {
                        const nameSpan = cam.querySelector('.camera-name');
                        if (nameSpan) {
                            const name = nameSpan.textContent;
                            const id = cam.id;
                            cameraSlotSelect.innerHTML += `<option value="${id}" class="text-black">Thay thế: ${name}</option>`;
                        }
                    });
                }
                hideModal(pairingModal);
                showModal(selectCameraSlotModal);
            }

            function generatePairCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // SỬA LỖI: Bỏ đồng hồ, dùng localStorage
            const PEER_ID_KEY = 'var_simulator_peer_id';

            function resetPairing() {
                // Chỉ reset hiển thị, không xóa key
                if (pairingDefaultView) pairingDefaultView.classList.remove('hidden');
                if (pairingCodeView) pairingCodeView.classList.add('hidden');
                if (peer) { peer.destroy(); peer = null; }
                currentPeerId = null;
                // localStorage.removeItem(PEER_ID_KEY); // Không xóa key nữa
            }
            
            function loadOrCreatePeerId() {
                let storedId = localStorage.getItem(PEER_ID_KEY);
                if (!storedId) {
                    // Nếu chưa có, hiển thị nút "LẤY MÃ"
                    if (pairingDefaultView) pairingDefaultView.classList.remove('hidden');
                    if (pairingCodeView) pairingCodeView.classList.add('hidden');
                } else {
                    // Nếu đã có, tự động kết nối
                    console.log("Tìm thấy ID phòng đã lưu:", storedId);
                    currentPeerId = storedId;
                    if (pairCodeDisplay) pairCodeDisplay.textContent = currentPeerId;
                    if (pairingDefaultView) pairingDefaultView.classList.add('hidden');
                    if (pairingCodeView) pairingCodeView.classList.remove('hidden');
                    initializePeer(currentPeerId);
                }
            }

            if (btnGetPairCode) {
                btnGetPairCode.addEventListener('click', () => {
                    currentPeerId = generatePairCode();
                    localStorage.setItem(PEER_ID_KEY, currentPeerId); // Lưu ID
                    if (pairCodeDisplay) pairCodeDisplay.textContent = currentPeerId;
                    
                    if (pairingDefaultView) pairingDefaultView.classList.add('hidden');
                    if (pairingCodeView) pairingCodeView.classList.remove('hidden');
                    
                    initializePeer(currentPeerId);
                });
            }
            
            loadOrCreatePeerId(); // Tự động tải khi mở trang

            if (btnRejectPairing) {
                btnRejectPairing.addEventListener('click', () => {
                    if (incomingConnection) incomingConnection.close();
                    if (incomingCall) incomingCall.close();
                    incomingConnection = null;
                    incomingCall = null;
                    hideModal(pairingModal);
                });
            }
            
            if (btnAcceptPairing) {
                btnAcceptPairing.addEventListener('click', () => {
                    if (incomingConnection) incomingConnection.send('accepted');
                    if (incomingCall) openSelectSlotModal(incomingCall);
                    hideModal(pairingModal);
                });
            }

            if (btnCancelSelectSlot) {
                btnCancelSelectSlot.addEventListener('click', () => {
                    if (incomingCall) incomingCall.close();
                    incomingCall = null;
                    incomingConnection = null;
                    hideModal(selectCameraSlotModal);
                });
            }
            
            if (btnConfirmSelectSlot) {
                btnConfirmSelectSlot.addEventListener('click', () => {
                    const selectedSlotId = cameraSlotSelect.value;
                    if (!incomingCall) {
                        console.error("Không tìm thấy cuộc gọi đến!");
                        hideModal(selectCameraSlotModal);
                        return;
                    }
                    incomingCall.answer(); 
                    incomingCall.on('stream', (remoteStream) => {
                        console.log("ĐÃ NHẬN STREAM VIDEO!", remoteStream);
                        let newOrUpdatedCam;
                        if (selectedSlotId === 'new') {
                            const newId = `cam-webrtc-${incomingCall.peer}`;
                            const newName = `Remote Cam (${incomingCall.peer.slice(0, 4)})`;
                            const newCam = createNewCameraElement(newId, newName, null, remoteStream);
                            if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                            newOrUpdatedCam = newCam;
                        } else {
                            const slotToReplace = document.getElementById(selectedSlotId);
                            if (slotToReplace) {
                                replaceCameraSlot(slotToReplace, remoteStream);
                                newOrUpdatedCam = slotToReplace;
                            }
                        }
                        if (newOrUpdatedCam) newOrUpdatedCam.click();
                    });
                    incomingCall.on('close', () => console.log("Stream video đã đóng."));
                    incomingCall.on('error', (err) => console.error("Lỗi stream:", err));
                    hideModal(selectCameraSlotModal);
                    incomingCall = null;
                    incomingConnection = null;
                });
            }
            
            function replaceCameraSlot(slotElement, stream) {
                const img = slotElement.querySelector('.camera-angle-image');
                const video = slotElement.querySelector('.camera-angle-video');
                slotElement.videoStream = stream;
                if (video) video.srcObject = stream;
                slotElement.removeAttribute('data-src');
                if (video) video.classList.remove('hidden');
                if (img) img.classList.add('hidden');
                playVideoSafe(video);
            }
            
            // --- 6. HÀM QUẢN LÝ AI (TensorFlow.js) ---
            
            async function loadModels() {
                try {
                    if (!window.tf || !window.blazeface || !window.cocoSsd) {
                        console.error("Thiếu thư viện TensorFlow.js hoặc models.");
                        return;
                    }
                    console.log("Đang tải model AI...");
                    await tf.setBackend('webgl');
                    const p1 = blazeface.load();
                    const p2 = cocoSsd.load();
                    [faceModel, objectModel] = await Promise.all([p1, p2]);
                    console.log("Đã tải xong 2 model AI (BlazeFace & COCO-SSD).");
                    if (btnToggleDetection) btnToggleDetection.disabled = false;
                } catch (err) {
                    console.error("Lỗi tải model AI:", err);
                }
            }
            
            async function runDetection() {
                if (!isDetectionRunning || (!faceModel && !objectModel) || !detCtx) return;
                
                const sourceElement = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;
                
                if (!sourceElement || sourceElement.paused || sourceElement.ended || sourceElement.readyState < 2) {
                    detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    return;
                }

                const p1 = faceModel ? faceModel.estimateFaces(sourceElement, false) : Promise.resolve([]);
                const p2 = objectModel ? objectModel.detect(sourceElement) : Promise.resolve([]);
                const [facePredictions, objectPredictions] = await Promise.all([p1, p2]);

                detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                detCtx.font = '16px "Be Vietnam Pro", sans-serif'; 
                detCtx.textBaseline = 'top';

                const videoRatio = sourceElement.videoWidth / sourceElement.videoHeight;
                const canvasRatio = detectionCanvas.width / detectionCanvas.height;
                let scale = 1, offsetX = 0, offsetY = 0;

                // Tính toán cho object-cover
                if (videoRatio > canvasRatio) { 
                     scale = detectionCanvas.height / sourceElement.videoHeight;
                     offsetX = (detectionCanvas.width - sourceElement.videoWidth * scale) / 2;
                     offsetY = 0;
                } else { 
                     scale = detectionCanvas.width / sourceElement.videoWidth;
                     offsetX = 0;
                     offsetY = (detectionCanvas.height - sourceElement.videoHeight * scale) / 2;
                }

                facePredictions.forEach(pred => {
                    const [startX, startY] = pred.topLeft;
                    const [endX, endY] = pred.bottomRight;
                    const [width, height] = [endX - startX, endY - startY];
                    const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                    detCtx.strokeStyle = '#32CD32'; 
                    detCtx.lineWidth = 2;
                    detCtx.strokeRect(x, y, w, h);
                    detCtx.fillStyle = '#32CD32';
                    detCtx.fillText('Face', x, y > 18 ? y - 18 : y + h + 4);
                });
                
                objectPredictions.forEach(pred => {
                    if (pred.class === 'sports ball') {
                        const [startX, startY, width, height] = pred.bbox;
                        const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                        detCtx.strokeStyle = '#FFD700'; 
                        detCtx.lineWidth = 2;
                        detCtx.strokeRect(x, y, w, h);
                        detCtx.fillStyle = '#FFD700';
                        const label = `Ball (${Math.round(pred.score * 100)}%)`;
                        detCtx.fillText(label, x, y > 18 ? y - 18 : y + h + 4);
                    }
                });
            }

            if (btnToggleDetection) {
                btnToggleDetection.disabled = true; 
                btnToggleDetection.addEventListener('click', () => {
                    isDetectionRunning = !isDetectionRunning;
                    // SỬA LỖI: Quay về logic cũ
                    const icon = btnToggleDetection.querySelector('.material-icons-round');
                    if (isDetectionRunning) {
                        btnToggleDetection.classList.add('danger');
                        btnToggleDetection.classList.remove('purple');
                        if (icon) icon.textContent = 'disabled_by_default'; // Tên icon "tắt" (ví dụ)
                        if (detectionInterval) clearInterval(detectionInterval);
                        detectionInterval = setInterval(runDetection, 100); 
                    } else {
                        btnToggleDetection.classList.remove('danger');
                        btnToggleDetection.classList.add('purple');
                        if (icon) icon.textContent = 'auto_awesome'; // Tên icon "bật"
                        if (detectionInterval) clearInterval(detectionInterval);
                        if (detCtx) detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height); 
                    }
                });
            }
            
            loadModels();
        }

        if (typeof Peer === 'undefined') {
            alert('Lỗi: Không thể tải thư viện PeerJS. Vui lòng kiểm tra kết nối mạng và thử tải lại trang.');
        } else {
            main().catch(console.error);
        }

    </script>
</body>
</html>
