<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh m√¥ ph·ªèng VAR</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- T·∫£i PeerJS (thay th·∫ø Firebase) -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- T·∫£i TensorFlow.js v√† c√°c model AI -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@latest/dist/blazeface.min.js"></script>

    <!-- T·∫£i Font Be Vietnam Pro -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    
    <!-- T·∫£i Material Icons Round -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* N·ªÅn ch√≠nh */
        html {
            background-image: url('https://images.ctfassets.net/seegk6e7ypwi/60TvXEVrvciW5CvsnqQmYZ/599e887296658b7297caa4400b27196a/fc-26-community-background-image.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        body {
            font-family: "Be Vietnam Pro", sans-serif;
            overflow: hidden;
            background: transparent;
            color: white;
        }
        
        /* Panel n·ªÅn ƒëen 50% */
        .glass-panel {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* N√∫t n·ªÅn ƒëen 50% */
        .glass-button {
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease-in-out;
            color: white; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .glass-button:hover {
            background-color: rgba(20, 20, 20, 0.7); 
        }
        .glass-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .glass-button.danger { background-color: rgba(220, 38, 38, 0.5); }
        .glass-button.danger:hover { background-color: rgba(220, 38, 38, 0.7); }
        .glass-button.success { background-color: rgba(22, 163, 74, 0.5); }
        .glass-button.success:hover { background-color: rgba(22, 163, 74, 0.7); }
        .glass-button.warning { background-color: rgba(234, 179, 8, 0.5); }
        .glass-button.warning:hover { background-color: rgba(234, 179, 8, 0.7); }
        .glass-button.info { background-color: rgba(59, 130, 246, 0.5); }
        .glass-button.info:hover { background-color: rgba(59, 130, 246, 0.7); }
        .glass-button.purple { background-color: rgba(139, 92, 246, 0.5); }
        .glass-button.purple:hover { background-color: rgba(139, 92, 246, 0.7); }
        .glass-button.active {
            background-color: rgba(59, 130, 246, 0.7); /* Blue */
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        /* Scrollbar t√πy ch·ªânh */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.5); }

        /* CSS t√πy ch·ªânh cho canvas */
        #reviewCanvas { cursor: crosshair; touch-action: none; }
        .decision-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            border-width: 2px;
        }
        
        /* ·∫®n dropdown menu (cho n√∫t 3 ch·∫•m) */
        .camera-menu { display: none; }
        .group:hover .camera-menu,
        .group:focus-within .camera-menu { display: block; }
        
        /* Wrapper cho thumbnail 16:9 */
        .camera-angle-wrapper {
            aspect-ratio: 16 / 9;
            background-color: #000;
        }
        .camera-angle-video, .camera-angle-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Canvas cho AI detection */
        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Cho ph√©p click xuy√™n qua */
        }
        
        /* Style cho FONT ICON */
        .btn-icon {
            font-size: 1.25rem; /* 20px */
            line-height: 1;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }
        .btn-icon-sm {
            font-size: 1rem; /* 16px */
            line-height: 1;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }
        .menu-icon {
            font-size: 1.25rem; /* 20px */
            margin-right: 0.5rem; /* mr-2 */
        }
        
        /* ƒê·∫£m b·∫£o text input trong modal c√≥ m√†u tr·∫Øng */
        input::placeholder { color: #9ca3af; /* gray-400 */ }
        input { color: white; }
        select { color: white; background-image: none; }
        select option { color: black; background: white; }
        
        /* Hi·ªáu ·ª©ng ƒë√†n h·ªìi cho Modal */
        .modal {
            transition: opacity 300ms ease-out, transform 300ms cubic-bezier(0.18, 0.89, 0.32, 1.28); /* ease-out-back */
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: flex; 
        }
        .modal.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; 
        }
        .modal:not(.open) {
             visibility: hidden;
        }
        
        /* Menu popup (cho B·∫£ng ƒëi·ªÅu khi·ªÉn) */
        .popup-menu {
            transition: opacity 200ms ease-out, transform 200ms ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            visibility: hidden;
            z-index: 100; 
        }
        .popup-menu.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }
        
        /* Tooltip (Ch√∫ th√≠ch) */
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            position: absolute;
            z-index: 101; 
            bottom: 125%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Container ch√≠nh (N·ªôi dung) -->
    <div class="p-4 flex-grow flex flex-col overflow-y-auto">
        
        <main class="flex flex-col lg:flex-row gap-6">
            
            <div class="lg:w-2/3 flex flex-col gap-5">
                <!-- B·∫£ng M√†n h√¨nh ch√≠nh -->
                <div class="glass-panel p-5 flex-grow flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">M√†n h√¨nh ch√≠nh</h2>
                    
                    <!-- M√†n h√¨nh xem l·∫°i (C√ì B·∫¢NG ƒêI·ªÄU KHI·ªÇN B√äN TRONG) -->
                    <div id="reviewScreen" class="relative w-full aspect-video bg-black rounded-md overflow-hidden">
                        
                        <div id="singleView" class="w-full h-full">
                            <img id="mainVideoFeedImage" 
                                 src="https://placehold.co/1920x1080/22c55e/ffffff?text=S√¢n+c·ªè" 
                                 alt="Video feed image" 
                                 class="w-full h-full object-cover">
                            <video id="mainVideoFeedVideo"
                                   alt="Video feed video"
                                   class="w-full h-full object-cover hidden"
                                   autoplay muted playsinline></video>
                            <canvas id="reviewCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                            <canvas id="detectionCanvas" class="absolute top-0 left-0"></canvas>
                        </div>
                        
                        <div id="gridView" class="w-full h-full grid grid-cols-2 gap-1 hidden">
                            <!-- C√°c √¥ l∆∞·ªõi s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                        </div>

                        <!-- B·∫¢NG ƒêI·ªÄU KHI·ªÇN M·ªöI (N·∫±m B√äN TRONG, ƒê√à L√äN) -->
                        <!-- C·ª•m b√™n TR√ÅI -->
                        <div class="absolute z-10 bottom-2 left-2 p-2 glass-panel rounded-lg">
                            <div class="flex items-center gap-2">
                                <button id="btnPrevFrame" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">skip_previous</span>
                                    <span class="tooltip-text">Frame tr∆∞·ªõc</span>
                                </button>
                                <button id="btnBack3s" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">fast_rewind</span>
                                    <span class="tooltip-text">L√πi 3s</span>
                                </button>
                                <button id="btnTogglePlay" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span id="playPauseIcon" class="material-icons-round btn-icon">play_arrow</span>
                                    <span id="playPauseTooltip" class="tooltip-text">Ph√°t</span>
                                </button>
                                <button id="btnForward3s" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">fast_forward</span>
                                    <span class="tooltip-text">T·ªõi 3s</span>
                                </button>
                                <button id="btnNextFrame" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">skip_next</span>
                                    <span class="tooltip-text">Frame sau</span>
                                </button>
                                <div class="text-sm font-mono ml-2 hidden md:block" title="Th·ªùi gian">
                                    00:00 / 00:00
                                </div>
                            </div>
                        </div>
                        
                        <!-- C·ª•m b√™n PH·∫¢I -->
                        <div class="absolute z-10 bottom-2 right-2 p-2 glass-panel rounded-lg">
                            <div class="flex items-center gap-2">
                                <!-- N√∫t B·ªë c·ª•c (M·ªõi) -->
                                <div class="relative tooltip">
                                    <button id="btnOpenLayoutMenu" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200">
                                        <span class="material-icons-round btn-icon">view_quilt</span>
                                    </button>
                                    <span class="tooltip-text">B·ªë c·ª•c</span>
                                    <!-- Menu B·ªë c·ª•c -->
                                    <div id="layoutMenu" class="popup-menu absolute bottom-full right-0 mb-2 w-48 glass-panel rounded-lg shadow-lg p-4">
                                        <label for="layoutRadioSingle" class="flex items-center gap-2 mb-2 p-2 rounded-lg hover:bg-white/10 cursor-pointer">
                                            <input type="radio" id="layoutRadioSingle" name="layoutType" value="single" class="text-blue-500 focus:ring-blue-400" checked>
                                            ƒê∆°n
                                        </label>
                                        <label for="layoutRadioGrid" class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/10 cursor-pointer">
                                            <input type="radio" id="layoutRadioGrid" name="layoutType" value="grid" class="text-blue-500 focus:ring-blue-400">
                                            X·∫øp k·ªÅ
                                        </label>
                                        <input type="number" id="gridInput" class="glass-button text-white text-sm rounded-lg py-2 px-3 w-full mt-2 hidden" placeholder="S·ªë √¥ (v√≠ d·ª•: 4)" value="4">
                                    </div>
                                </div>
                                
                                <button id="btnGoToIncident" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">movie</span>
                                    <span class="tooltip-text">T·ªõi S·ª± c·ªë</span>
                                </button>
                                <button id="btnScreenshot" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span class="material-icons-round btn-icon">camera_alt</span>
                                    <span class="tooltip-text">Ch·ª•p ·∫£nh</span>
                                </button>
                                <button id="btnToggleDetection" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip purple">
                                    <span class="material-icons-round btn-icon">auto_awesome</span>
                                    <span class="tooltip-text">B·∫≠t/T·∫Øt Detect</span>
                                </button>
                                
                                <!-- N√∫t More (M·ªõi) -->
                                <div class="relative tooltip">
                                    <button id="btnOpenMoreMenu" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200">
                                        <span class="material-icons-round btn-icon">more_vert</span>
                                    </button>
                                    <span class="tooltip-text">Th√™m</span>
                                    <!-- Menu More -->
                                    <div id="moreMenu" class="popup-menu absolute bottom-full right-0 mb-2 w-56 glass-panel rounded-lg shadow-lg overflow-hidden">
                                        <div id="btnOpenSpeedMenu" class="relative w-full text-left px-4 py-3 hover:bg-white/10 transition cursor-pointer flex items-center gap-2">
                                            <span class="material-icons-round">speed</span> T·ªëc ƒë·ªô ph√°t...
                                        </div>
                                        <!-- Menu T·ªëc ƒë·ªô (con) -->
                                        <div id="speedMenu" class="popup-menu absolute bottom-0 right-full mr-2 w-48 glass-panel rounded-lg shadow-lg p-3">
                                            <span class="text-sm">T·ªëc ƒë·ªô</span>
                                            <div class="grid grid-cols-4 gap-1 mt-2">
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="0.25">0.25</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="0.5">0.5</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="0.75">0.75</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded active bg-blue-600" data-speed="1">1x</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="1.25">1.25</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="1.5">1.5</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="1.75">1.75</button>
                                                <button class="btn-speed glass-button text-xs p-1 rounded" data-speed="2">2x</button>
                                            </div>
                                        </div>
                                        <button class="w-full text-left px-4 py-3 hover:bg-white/10 transition flex items-center gap-2">
                                            <span class="material-icons-round">high_quality</span> Ch·∫•t l∆∞·ª£ng...
                                        </button>
                                    </div>
                                </div>
                                
                                <button id="btnToggleFullscreen" class="glass-button text-white font-bold p-2 rounded-lg transition duration-200 tooltip">
                                    <span id="iconFullscreen" class="material-icons-round btn-icon">fullscreen</span>
                                    <span id="iconExitFullscreen" class="material-icons-round btn-icon hidden">fullscreen_exit</span>
                                    <span class="tooltip-text">To√†n m√†n h√¨nh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- B·∫¢NG ƒêI·ªÄU KHI·ªÇN V·∫º V·∫†CH (Ri√™ng bi·ªát, n·∫±m B√äN D∆Ø·ªöI) -->
                    <div class="mt-4 p-4 glass-panel rounded-lg">
                        <div class="flex items-center gap-2 justify-center">
                            <span class="text-sm font-medium hidden lg:inline mr-2">V·∫Ω v·∫°ch:</span>
                            <button id="btnDrawRedLine" class="glass-button text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                Tƒê
                                <span class="tooltip-text">V·∫°ch T·∫•n c√¥ng</span>
                            </button>
                            <button id="btnDrawBlueLine" class="glass-button text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                HV
                                <span class="tooltip-text">V·∫°ch H·∫≠u v·ªá</span>
                            </button>
                            <button id="btnClearLines" class="glass-button text-white py-2 px-3 rounded-lg transition duration-200 tooltip">
                                X√≥a
                                <span class="tooltip-text">X√≥a v·∫°ch</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- C·ªôt b√™n ph·∫£i: C√°c g√≥c m√°y & Quy·∫øt ƒë·ªãnh -->
            <div class="lg:w-1/3 flex flex-col gap-6">
                
                <!-- C√°c g√≥c m√°y quay -->
                <div class="glass-panel p-4">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h2 class="text-2xl font-semibold">G√≥c m√°y quay</h2>
                        <button id="btnOpenAddCameraModal" class="glass-button text-white font-bold w-8 h-8 rounded-full flex items-center justify-center tooltip">
                            <span class="material-icons-round btn-icon-sm">add</span>
                            <span class="tooltip-text">Th√™m camera</span>
                        </button>
                    </div>
                    <!-- Thanh cu·ªôn ngang ch·ª©a c√°c g√≥c m√°y -->
                    <div id="cameraAngleContainer" class="flex overflow-x-auto gap-3 pb-2">
                        <!-- Camera 1 -->
                        <div id="cam-init-1" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/22c55e/ffffff?text=Main+Cam" 
                                 alt="Main Cam" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/22c55e/ffffff?text=Main+Cam">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Main Cam</span>
                            <!-- N√∫t 3 ch·∫•m -->
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <!-- Menu t√πy ch·ªçn -->
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    ƒê·ªïi t√™n
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    X√≥a
                                </a>
                            </div>
                        </div>
                        <!-- Camera 2 -->
                        <div id="cam-init-2" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/eab308/ffffff?text=G√≥c+16m50" 
                                 alt="G√≥c 16m50" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/eab308/ffffff?text=G√≥c+16m50">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">G√≥c 16m50</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    ƒê·ªïi t√™n
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    X√≥a
                                </a>
                            </div>
                        </div>
                        <!-- Camera 3 -->
                        <div id="cam-init-3" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/ef4444/ffffff?text=Sau+g√¥n+A" 
                                 alt="Sau g√¥n A" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/ef4444/ffffff?text=Sau+g√¥n+A">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau g√¥n A</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    ƒê·ªïi t√™n
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    X√≥a
                                </a>
                            </div>
                        </div>
                        <!-- Camera 4 -->
                        <div id="cam-init-4" class="camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition">
                            <img src="https://placehold.co/300x200/3b82f6/ffffff?text=Sau+g√¥n+B" 
                                 alt="Sau g√¥n B" 
                                 class="camera-angle camera-angle-image w-full h-full object-cover" 
                                 data-src="https://placehold.co/1920x1080/3b82f6/ffffff?text=Sau+g√¥n+B">
                            <video class="camera-angle-video hidden" autoplay muted playsinline></video>
                            <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">Sau g√¥n B</span>
                            <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                                <span class="material-icons-round text-lg">more_vert</span>
                            </button>
                            <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                                <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                                    ƒê·ªïi t√™n
                                </a>
                                <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                                    <span class="material-icons-round menu-icon text-red-600">delete</span>
                                    X√≥a
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quy·∫øt ƒë·ªãnh c·ªßa VAR -->
                <div class="glass-panel p-4 lg:sticky top-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Ra quy·∫øt ƒë·ªãnh</h2>
                    <div class="space-y-3">
                        <button class="decision-btn glass-button success w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="B√ÄN TH·∫ÆNG H·ª¢P L·ªÜ">
                            ‚úÖ B√†n th·∫Øng
                        </button>
                        <button class="decision-btn glass-button danger w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="KH√îNG C√ì B√ÄN TH·∫ÆNG (Vi·ªát v·ªã)">
                            ‚ùå Kh√¥ng c√≥ b√†n th·∫Øng
                        </button>
                        <button class="decision-btn glass-button warning w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="TH·∫∫ V√ÄNG">
                            üü® Th·∫ª v√†ng
                        </button>
                        <button class="decision-btn glass-button danger w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="TH·∫∫ ƒê·ªé">
                            üü• Th·∫ª ƒë·ªè
                        </button>
                        <button class="decision-btn glass-button info w-full text-lg text-white font-bold py-3 px-4 rounded-lg" data-decision="PENALTY">
                            üÖøÔ∏è Penalty
                        </button>
                    </div>
                    <div id="finalDecisionBox" class="mt-4 p-4 bg-gray-900 bg-opacity-50 rounded-lg text-center hidden">
                        <h3 class="text-lg font-bold text-yellow-400">QUY·∫æT ƒê·ªäNH CU·ªêI C√ôNG</h3>
                        <p id="decisionText" class="text-2xl font-bold mt-2"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer c·ªë ƒë·ªãnh -->
    <footer class="w-full bg-gray-950 text-gray-400 p-2 border-t border-gray-800 flex-shrink-0">
        <div class="px-4 flex justify-between items-center">
            <div id="clockDate" class="text-sm font-medium">ƒêang t·∫£i...</div>
            <div id="pairing-section" class="flex items-center gap-2">
                <div id="pairing-default-view" class="flex items-center gap-2">
                    <button id="btnGetPairCode" class="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition tooltip">
                        <span class="material-icons-round btn-icon-sm">add_link</span>
                        <span class="hidden md:inline">L·∫§Y M√É GH√âP ƒê√îI</span>
                        <span class="tooltip-text">L·∫•y m√£ gh√©p ƒë√¥i</span>
                    </button>
                </div>
                <div id="pairing-code-view" class="hidden items-center gap-3">
                    <span class="text-lg font-bold tracking-widest text-yellow-400" id="pairCodeDisplay"></span>
                    <div class="flex items-center text-gray-500 text-sm">
                        <span class="material-icons-round text-sm mr-1">timer</span>
                        <span id="pairingTimer">05:00</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    
    <!-- === C√ÅC C·ª¨A S·ªî POPUP (MODAL) === -->
    
    <div id="renameModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">ƒê·ªïi t√™n Camera</h3>
            <input type="text" id="renameInput" class="w-full glass-button text-white rounded-lg px-4 py-2" placeholder="Nh·∫≠p t√™n m·ªõi...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelRename" class="glass-button text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnSaveRename" class="glass-button info text-white font-bold py-2 px-4 rounded-lg transition">L∆∞u</button>
            </div>
        </div>
    </div>
    
    <div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">X√°c nh·∫≠n X√≥a</h3>
            <p class="text-gray-300 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a g√≥c m√°y quay n√†y kh√¥ng?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelDelete" class="glass-button text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmDelete" class="glass-button danger text-white font-bold py-2 px-4 rounded-lg transition">OK, X√≥a</button>
            </div>
        </div>
    </div>

    <div id="addCameraModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Th√™m Camera</h3>
            <input type="text" id="addCameraNameInput" class="w-full glass-button text-white rounded-lg px-4 py-2" placeholder="Nh·∫≠p t√™n camera m·ªõi...">
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="btnCancelAddCamera" class="glass-button text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmAddCamera" class="glass-button info text-white font-bold py-2 px-4 rounded-lg transition">Th√™m</button>
            </div>
        </div>
    </div>
    
    <div id="pairingModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Y√™u c·∫ßu Gh√©p ƒë√¥i</h3>
            <p class="text-gray-300 mb-6">M·ªôt thi·∫øt b·ªã (ID: <span id="incomingPeerId" class="font-bold">...</span>) ƒëang c·ªë g·∫Øng k·∫øt n·ªëi. B·∫°n c√≥ ch·∫•p nh·∫≠n kh√¥ng?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnRejectPairing" class="glass-button text-white font-bold py-2 px-4 rounded-lg transition">Kh√¥ng ph·∫£i</button>
                <button type="button" id="btnAcceptPairing" class="glass-button success text-white font-bold py-2 px-4 rounded-lg transition">Ph·∫£i</button>
            </div>
        </div>
    </div>
    
    <div id="selectCameraSlotModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="glass-panel rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Ch·ªçn V·ªã tr√≠ Camera</h3>
            <p class="text-gray-300 mb-4">ƒê·∫∑t camera m·ªõi n√†y v√†o v·ªã tr√≠ n√†o?</p>
            <select id="cameraSlotSelect" class="w-full glass-button text-white rounded-lg px-4 py-2 mb-4">
                <option value="new" class="text-black">-- Th√™m l√†m camera m·ªõi --</option>
            </select>
            <div class="flex justify-end gap-3">
                <button type="button" id="btnCancelSelectSlot" class="glass-button text-white font-bold py-2 px-4 rounded-lg transition">H·ªßy</button>
                <button type="button" id="btnConfirmSelectSlot" class="glass-button info text-white font-bold py-2 px-4 rounded-lg transition">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    
    <!-- ================================== -->
    <!-- === SCRIPT CH√çNH C·ª¶A ·ª®NG D·ª§NG === -->
    <!-- ================================== -->
    <script type="module">
        // Bi·∫øn to√†n c·ª•c cho PeerJS
        let peer = null;
        let currentPeerId = null;
        let pairingTimerInterval = null;
        let incomingConnection = null; // L∆∞u k·∫øt n·ªëi (DataConnection)
        let incomingCall = null; // L∆∞u cu·ªôc g·ªçi (MediaConnection)
        
        // Bi·∫øn to√†n c·ª•c cho AI
        let faceModel = null;
        let objectModel = null;
        let isDetectionRunning = false;
        let detectionInterval = null;
        
        // Bi·∫øn to√†n c·ª•c cho Camera Modals
        let activeCameraElement = null; // Camera ƒëang ƒë∆∞·ª£c s·ª≠a/x√≥a

        // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
        
        async function playVideoSafe(videoElement) {
            if (!videoElement) return;
            videoElement.muted = true;
            try {
                await videoElement.play();
            } catch (error) {
                if (error.name !== 'AbortError' && !error.message.includes('interrupted')) {
                    console.error(`L·ªói ph√°t video (${videoElement.id || 'N/A'}):`, error.message);
                }
            }
        }
        
        function showModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('modal:not(.open)');
                requestAnimationFrame(() => {
                    modalElement.classList.add('open');
                });
            }
        }

        function hideModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('open');
                setTimeout(() => {
                    modalElement.classList.add('modal:not(.open)');
                }, 300);
            }
        }

        function togglePopupMenu(menuElement) {
            if (!menuElement) return;
            const isOpen = menuElement.classList.contains('open');
            hideAllPopups(); // Lu√¥n ·∫©n t·∫•t c·∫£ tr∆∞·ªõc
            if (!isOpen) {
                menuElement.classList.add('open');
            }
        }
        
        function hideAllPopups(exceptMenu = null) {
            document.querySelectorAll('.popup-menu').forEach(menu => {
                if (menu !== exceptMenu && !menu.contains(exceptMenu)) {
                    menu.classList.remove('open');
                }
            });
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                hideAllPopups();
            }
        });


        // --- H√ÄM KH·ªûI T·∫†O CH√çNH ---
        
        async function main() {
            // Kh·ªüi t·∫°o c√°c bi·∫øn DOM
            const mainVideoFeedImage = document.getElementById('mainVideoFeedImage');
            const mainVideoFeedVideo = document.getElementById('mainVideoFeedVideo');
            const cameraAngleContainer = document.getElementById('cameraAngleContainer');
            const decisionButtons = document.querySelectorAll('.decision-btn');
            const finalDecisionBox = document.getElementById('finalDecisionBox');
            const decisionText = document.getElementById('decisionText');
            
            // DOM B·∫£ng ƒëi·ªÅu khi·ªÉn M·ªöI
            const btnPrevFrame = document.getElementById('btnPrevFrame');
            const btnBack3s = document.getElementById('btnBack3s');
            const btnTogglePlay = document.getElementById('btnTogglePlay');
            const playPauseIcon = document.getElementById('playPauseIcon');
            const playPauseTooltip = document.getElementById('playPauseTooltip'); // S·ª≠a l·ªói tooltip
            const btnForward3s = document.getElementById('btnForward3s');
            const btnNextFrame = document.getElementById('btnNextFrame');
            
            const btnDrawRedLine = document.getElementById('btnDrawRedLine');
            const btnDrawBlueLine = document.getElementById('btnDrawBlueLine');
            const btnClearLines = document.getElementById('btnClearLines');

            const btnOpenLayoutMenu = document.getElementById('btnOpenLayoutMenu');
            const layoutMenu = document.getElementById('layoutMenu');
            const layoutRadioSingle = document.getElementById('layoutRadioSingle');
            const layoutRadioGrid = document.getElementById('layoutRadioGrid');
            const gridInput = document.getElementById('gridInput');
            
            const btnGoToIncident = document.getElementById('btnGoToIncident');
            const btnScreenshot = document.getElementById('btnScreenshot');
            const btnToggleDetection = document.getElementById('btnToggleDetection');
            
            const btnOpenMoreMenu = document.getElementById('btnOpenMoreMenu');
            const moreMenu = document.getElementById('moreMenu');
            const btnOpenSpeedMenu = document.getElementById('btnOpenSpeedMenu');
            const speedMenu = document.getElementById('speedMenu');
            const speedButtons = document.querySelectorAll('.btn-speed');
            
            const btnToggleFullscreen = document.getElementById('btnToggleFullscreen');
            const iconFullscreen = document.getElementById('iconFullscreen');
            const iconExitFullscreen = document.getElementById('iconExitFullscreen');
            
            // DOM Canvas
            const canvas = document.getElementById('reviewCanvas');
            const ctx = canvas.getContext('2d');
            const detectionCanvas = document.getElementById('detectionCanvas');
            const detCtx = detectionCanvas.getContext('2d');
            
            // DOM Ch·∫ø ƒë·ªô xem
            const singleView = document.getElementById('singleView');
            const gridView = document.getElementById('gridView');
            
            // ƒê·ªìng h·ªì
            const clockDateElement = document.getElementById('clockDate');

            // C√°c n√∫t Camera Modal
            const btnOpenAddCameraModal = document.getElementById('btnOpenAddCameraModal');
            const addCameraModal = document.getElementById('addCameraModal');
            const btnCancelAddCamera = document.getElementById('btnCancelAddCamera');
            const btnConfirmAddCamera = document.getElementById('btnConfirmAddCamera');
            const addCameraNameInput = document.getElementById('addCameraNameInput');

            const renameModal = document.getElementById('renameModal');
            const btnCancelRename = document.getElementById('btnCancelRename');
            const btnSaveRename = document.getElementById('btnSaveRename');
            const renameInput = document.getElementById('renameInput');

            const deleteModal = document.getElementById('deleteModal');
            const btnCancelDelete = document.getElementById('btnCancelDelete');
            const btnConfirmDelete = document.getElementById('btnConfirmDelete');

            // C√°c n√∫t Pairing Modal
            const btnGetPairCode = document.getElementById('btnGetPairCode');
            const pairingDefaultView = document.getElementById('pairing-default-view');
            const pairingCodeView = document.getElementById('pairing-code-view');
            const pairCodeDisplay = document.getElementById('pairCodeDisplay');
            const pairingTimer = document.getElementById('pairingTimer');
            const pairingModal = document.getElementById('pairingModal');
            const btnRejectPairing = document.getElementById('btnRejectPairing');
            const btnAcceptPairing = document.getElementById('btnAcceptPairing');
            const incomingPeerId = document.getElementById('incomingPeerId');

            // C√°c n√∫t Select Slot Modal
            const selectCameraSlotModal = document.getElementById('selectCameraSlotModal');
            const cameraSlotSelect = document.getElementById('cameraSlotSelect');
            const btnCancelSelectSlot = document.getElementById('btnCancelSelectSlot');
            const btnConfirmSelectSlot = document.getElementById('btnConfirmSelectSlot');
            
            // ·∫®n t·∫•t c·∫£ modal khi b·∫Øt ƒë·∫ßu
            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('modal:not(.open)'));

            let isPlaying = false;
            let currentLineColor = 'red';
            let isDrawing = false;
            let startX, startY;
            const incidentImageSrc = 'https://placehold.co/1920x1080/db2777/ffffff?text=T√¨nh+hu·ªëng+Vi·ªát+v·ªã';
            
            // --- 0. KH·ªûI T·∫†O ƒê·ªíNG H·ªí ---
            function updateClock() {
                const now = new Date();
                const options = {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour12: false
                };
                if (clockDateElement) {
                    clockDateElement.textContent = now.toLocaleDateString('vi-VN', options);
                }
            }
            setInterval(updateClock, 1000);
            updateClock();

            // --- 1. H√ÄM V·∫º V·∫†CH (CANVAS) ---
            function resizeCanvas(sourceElement) {
                if (!sourceElement || !canvas) return;
                
                requestAnimationFrame(() => {
                    const reviewScreen = document.getElementById('reviewScreen');
                    if (!reviewScreen) return;
                    
                    const rect = reviewScreen.getBoundingClientRect();
                    
                    if (rect.width === 0 || rect.height === 0) return;
                    
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    canvas.style.width = `${rect.width}px`;
                    canvas.style.height = `${rect.height}px`;
                    
                    detectionCanvas.width = rect.width;
                    detectionCanvas.height = rect.height;
                    detectionCanvas.style.width = `${rect.width}px`;
                    detectionCanvas.style.height = `${rect.height}px`;
                });
            }

            window.addEventListener('resize', () => {
                const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                resizeCanvas(currentFeed);
            });
            mainVideoFeedImage.onload = () => resizeCanvas(mainVideoFeedImage);
            mainVideoFeedVideo.onloadedmetadata = () => resizeCanvas(mainVideoFeedVideo);
            resizeCanvas(mainVideoFeedImage);


            function clearLines() {
                if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function getMousePos(evt) {
                const reviewRect = document.getElementById('reviewScreen').getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const scaleX = canvas.width / canvasRect.width;
                const scaleY = canvas.height / canvasRect.height;
                
                let clientX = evt.clientX;
                let clientY = evt.clientY;

                if (evt.touches && evt.touches.length > 0) {
                    clientX = evt.touches[0].clientX;
                    clientY = evt.touches[0].clientY;
                }

                return {
                    x: (clientX - canvasRect.left) * scaleX,
                    y: (clientY - canvasRect.top) * scaleY
                };
            }

            function startDrawing(e) {
                e.preventDefault();
                if (singleView.classList.contains('hidden')) return;
                isDrawing = true;
                const pos = getMousePos(e);
                startX = pos.x;
                startY = pos.y;
            }

            function draw(e) {
                e.preventDefault();
                if (!isDrawing || singleView.classList.contains('hidden')) return;
                clearLines(); 
                const pos = getMousePos(e);
                ctx.beginPath();
                ctx.strokeStyle = currentLineColor;
                ctx.lineWidth = 4;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.moveTo(startX, startY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stopDrawing(e) {
                e.preventDefault();
                isDrawing = false;
            }

            if (canvas) {
                const reviewScreen = document.getElementById('reviewScreen');
                reviewScreen.addEventListener('mousedown', startDrawing);
                reviewScreen.addEventListener('touchstart', startDrawing);
                
                // S·ª¨A L·ªñI: G·∫Øn v√†o window
                window.addEventListener('mousemove', draw);
                window.addEventListener('touchmove', draw);
                window.addEventListener('mouseup', stopDrawing);
                window.addEventListener('touchend', stopDrawing);
                window.addEventListener('touchcancel', stopDrawing);
            }
            
            if (btnDrawRedLine) btnDrawRedLine.addEventListener('click', () => currentLineColor = '#ef4444');
            if (btnDrawBlueLine) btnDrawBlueLine.addEventListener('click', () => currentLineColor = '#3b82f6');
            if (btnClearLines) btnClearLines.addEventListener('click', clearLines);

            // --- 2. H√ÄM ƒêI·ªÄU KHI·ªÇN CH√çNH ---

            function setupCameraAngleClick(camElement) {
                camElement.addEventListener('click', async (e) => {
                    if (e.target.closest('.btn-camera-options') || e.target.closest('.camera-menu')) return;
                    if (layoutRadioGrid.checked) layoutRadioSingle.click(); 
                    
                    clearLines(); 
                    
                    const imgSrc = camElement.dataset.src;
                    const videoStream = camElement.videoStream;

                    if (videoStream) {
                        mainVideoFeedImage.classList.add('hidden');
                        mainVideoFeedVideo.classList.remove('hidden');
                        mainVideoFeedVideo.srcObject = videoStream;
                        await playVideoSafe(mainVideoFeedVideo);
                        resizeCanvas(mainVideoFeedVideo);
                    } else if (imgSrc) {
                        mainVideoFeedImage.classList.remove('hidden');
                        mainVideoFeedVideo.classList.add('hidden');
                        if (mainVideoFeedVideo.srcObject) {
                            mainVideoFeedVideo.srcObject.getTracks().forEach(track => track.stop());
                        }
                        mainVideoFeedVideo.srcObject = null;
                        mainVideoFeedImage.src = imgSrc;
                        resizeCanvas(mainVideoFeedImage);
                    }
                });
            }
            
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraAngleClick);

            if (btnGoToIncident) {
                btnGoToIncident.addEventListener('click', () => {
                    if (layoutRadioGrid.checked) layoutRadioSingle.click(); 
                    
                    mainVideoFeedImage.classList.remove('hidden');
                    mainVideoFeedVideo.classList.add('hidden');
                    if (mainVideoFeedVideo.srcObject) {
                        mainVideoFeedVideo.srcObject.getTracks().forEach(track => track.stop());
                    }
                    mainVideoFeedVideo.srcObject = null;
                    mainVideoFeedImage.src = incidentImageSrc;
                    
                    if (playPauseIcon) playPauseIcon.textContent = 'play_arrow';
                    if (playPauseTooltip) playPauseTooltip.textContent = 'Ph√°t';
                    isPlaying = false;
                    resizeCanvas(mainVideoFeedImage);
                });
            }

            if (btnTogglePlay) {
                btnTogglePlay.addEventListener('click', async () => {
                    isPlaying = !isPlaying;
                    const currentFeed = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;
                    
                    if (isPlaying) {
                        if (playPauseIcon) playPauseIcon.textContent = 'pause';
                        if (playPauseTooltip) playPauseTooltip.textContent = 'D·ª´ng';
                        if (currentFeed) await playVideoSafe(currentFeed);
                    } else {
                        if (playPauseIcon) playPauseIcon.textContent = 'play_arrow';
                        if (playPauseTooltip) playPauseTooltip.textContent = 'Ph√°t';
                        if (currentFeed) currentFeed.pause();
                    }
                });
            }

            decisionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const decision = btn.dataset.decision;
                    if (decisionText) decisionText.textContent = decision;
                    if (finalDecisionBox) finalDecisionBox.classList.remove('hidden');
                    decisionButtons.forEach(b => b.classList.remove('active', 'border-yellow-400', 'border-2'));
                    btn.classList.add('active', 'border-yellow-400', 'border-2');
                });
            });

            // --- 3. H√ÄM QU·∫¢N L√ù B·ªê C·ª§C (Layout M·ªöI) ---
            
            if (btnOpenLayoutMenu) {
                btnOpenLayoutMenu.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    togglePopupMenu(layoutMenu);
                });
            }
            
            if (layoutRadioSingle) {
                layoutRadioSingle.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.add('hidden');
                    if (singleView) singleView.classList.remove('hidden');
                    if (gridView) gridView.classList.add('hidden');
                    const currentFeed = mainVideoFeedImage.classList.contains('hidden') ? mainVideoFeedVideo : mainVideoFeedImage;
                    resizeCanvas(currentFeed);
                    hideAllPopups();
                });
            }

            if (layoutRadioGrid) {
                layoutRadioGrid.addEventListener('click', () => {
                    if (gridInput) gridInput.classList.remove('hidden');
                    if (singleView) singleView.classList.add('hidden');
                    if (gridView) gridView.classList.remove('hidden');
                    updateGridView();
                    // Kh√¥ng ·∫©n popup ngay ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p s·ªë
                });
            }

            function updateGridView() {
                if (!gridView || !gridInput) return;
                
                const count = parseInt(gridInput.value) || 4;
                const cols = Math.ceil(Math.sqrt(count));
                gridView.className = `w-full h-full grid gap-1 grid-cols-${cols}`;
                gridView.innerHTML = '';
                
                const sources = Array.from(document.querySelectorAll('.camera-angle-wrapper'));
                
                for (let i = 0; i < count; i++) {
                    const sourceElement = sources[i % sources.length]; 
                    if (!sourceElement) continue;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'aspect-video bg-black rounded-md overflow-hidden'; 

                    if (sourceElement.videoStream) {
                        const videoElement = document.createElement('video');
                        videoElement.srcObject = sourceElement.videoStream;
                        videoElement.className = 'w-full h-full object-cover';
                        videoElement.autoplay = true;
                        videoElement.muted = true;
                        videoElement.playsinline = true;
                        wrapper.appendChild(videoElement);
                        gridView.appendChild(wrapper);
                        playVideoSafe(videoElement);
                    } else if (sourceElement.dataset.src) {
                        const imgElement = document.createElement('img');
                        imgElement.src = sourceElement.dataset.src;
                        imgElement.alt = `Camera ${i + 1}`;
                        imgElement.className = 'w-full h-full object-cover';
                        wrapper.appendChild(imgElement);
                        gridView.appendChild(wrapper);
                    }
                }
            }
            if (gridInput) gridInput.addEventListener('input', updateGridView);

            // --- 3.5. H√ÄM QU·∫¢N L√ù MENU "MORE" ---

            if (btnOpenMoreMenu) {
                btnOpenMoreMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePopupMenu(moreMenu);
                });
            }
            
            if (btnOpenSpeedMenu) {
                btnOpenSpeedMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // ·∫®n menu cha
                    hideAllPopups();
                    // M·ªü menu con
                    togglePopupMenu(speedMenu);
                });
            }
            
            speedButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const speed = parseFloat(e.currentTarget.dataset.speed);
                    speedButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                    e.currentTarget.classList.add('active', 'bg-blue-600');
                    mainVideoFeedVideo.playbackRate = speed;
                    hideAllPopups();
                });
            });
            
            if (btnToggleFullscreen) {
                btnToggleFullscreen.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                });
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        iconFullscreen.classList.remove('hidden');
                        iconExitFullscreen.classList.add('hidden');
                    } else {
                        iconFullscreen.classList.add('hidden');
                        iconExitFullscreen.classList.remove('hidden');
                    }
                });
            }

            // --- 4. H√ÄM QU·∫¢N L√ù CAMERA (Th√™m/S·ª≠a/X√≥a) ---

            function createNewCameraElement(id, name, imgSrc, stream = null) {
                const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                const placeholderImg = `https://placehold.co/300x200/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;
                const placeholderSrc = `https://placehold.co/1920x1080/${randomColor}/ffffff?text=${encodeURIComponent(name)}`;

                const wrapper = document.createElement('div');
                wrapper.id = id;
                wrapper.className = "camera-angle-wrapper group relative flex-shrink-0 w-40 rounded-md overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-400 transition";
                
                const img = document.createElement('img');
                img.className = "camera-angle camera-angle-image w-full h-full object-cover";
                img.alt = name;
                
                const video = document.createElement('video');
                video.className = "camera-angle-video hidden";
                video.autoplay = true;
                video.muted = true;
                video.playsinline = true;

                if (stream) {
                    wrapper.videoStream = stream; 
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    img.classList.add('hidden');
                } else {
                    img.src = imgSrc || placeholderImg;
                    wrapper.dataset.src = imgSrc || placeholderSrc;
                    video.classList.add('hidden');
                    img.classList.remove('hidden');
                }

                wrapper.innerHTML = `
                    ${img.outerHTML}
                    ${video.outerHTML}
                    <span class="camera-name absolute bottom-1 left-2 text-white text-sm font-bold" style="text-shadow: 1px 1px 2px black;">${name}</span>
                    <button class="btn-camera-options absolute top-1 right-1 bg-gray-900 bg-opacity-50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="T√πy ch·ªçn">
                        <span class="material-icons-round text-lg">more_vert</span>
                    </button>
                    <div class="camera-menu absolute top-8 right-1 bg-white text-black rounded-md shadow-lg z-10 overflow-hidden">
                        <a href="#" class="btn-rename-camera flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-200">
                            <span class="material-icons-round menu-icon text-black">drive_file_rename_outline</span>
                            ƒê·ªïi t√™n
                        </a>
                        <a href="#" class="btn-delete-camera flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-gray-200">
                            <span class="material-icons-round menu-icon text-red-600">delete</span>
                            X√≥a
                        </a>
                    </div>
                `;
                
                setupCameraAngleClick(wrapper);
                setupCameraOptionEvents(wrapper);
                
                if (stream) {
                    playVideoSafe(wrapper.querySelector('.camera-angle-video'));
                }
                
                return wrapper;
            }

            function setupCameraOptionEvents(cameraElement) {
                const btnOptions = cameraElement.querySelector('.btn-camera-options');
                const btnRename = cameraElement.querySelector('.btn-rename-camera');
                const btnDelete = cameraElement.querySelector('.btn-delete-camera');
                const menu = cameraElement.querySelector('.camera-menu');

                if (btnOptions) {
                    btnOptions.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    });
                }
                
                if (btnRename) {
                    btnRename.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement;
                        if (renameInput) renameInput.value = cameraElement.querySelector('.camera-name').textContent;
                        showModal(renameModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
                
                if (btnDelete) {
                    btnDelete.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        activeCameraElement = cameraElement;
                        showModal(deleteModal);
                        if (menu) menu.style.display = 'none';
                    });
                }
            }
            
            document.querySelectorAll('.camera-angle-wrapper').forEach(setupCameraOptionEvents);
            
            if (btnOpenAddCameraModal) btnOpenAddCameraModal.addEventListener('click', () => showModal(addCameraModal));
            if (btnCancelAddCamera) btnCancelAddCamera.addEventListener('click', () => hideModal(addCameraModal));
            if (btnConfirmAddCamera) {
                btnConfirmAddCamera.addEventListener('click', () => {
                    const name = addCameraNameInput.value.trim();
                    if (name) {
                        const newId = `cam-${Date.now()}`;
                        const newCam = createNewCameraElement(newId, name, null);
                        if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                        addCameraNameInput.value = '';
                        hideModal(addCameraModal);
                    }
                });
            }
            
            if (btnCancelRename) btnCancelRename.addEventListener('click', () => hideModal(renameModal));
            if (btnSaveRename) {
                btnSaveRename.addEventListener('click', () => {
                    const newName = renameInput.value.trim();
                    if (newName && activeCameraElement) {
                        const nameSpan = activeCameraElement.querySelector('.camera-name');
                        if (nameSpan) nameSpan.textContent = newName;
                        const img = activeCameraElement.querySelector('.camera-angle-image');
                        if (img) img.alt = newName;
                        if (activeCameraElement.dataset.src) {
                            try {
                                const oldSrc = new URL(activeCameraElement.dataset.src);
                                oldSrc.searchParams.set('text', newName);
                                activeCameraElement.dataset.src = oldSrc.href;
                                const thumbImg = activeCameraElement.querySelector('.camera-angle-image');
                                if (thumbImg) {
                                    const oldThumbSrc = new URL(thumbImg.src);
                                    oldThumbSrc.searchParams.set('text', newName);
                                    thumbImg.src = oldThumbSrc.href;
                                }
                            } catch(e) {
                                console.warn("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t text c·ªßa placeholder image", e);
                            }
                        }
                    }
                    hideModal(renameModal);
                    activeCameraElement = null;
                });
            }

            if (btnCancelDelete) btnCancelDelete.addEventListener('click', () => hideModal(deleteModal));
            if (btnConfirmDelete) {
                btnConfirmDelete.addEventListener('click', () => {
                    if (activeCameraElement) {
                        if (activeCameraElement.videoStream) {
                            activeCameraElement.videoStream.getTracks().forEach(track => track.stop());
                        }
                        activeCameraElement.remove();
                    }
                    hideModal(deleteModal);
                    activeCameraElement = null;
                });
            }

            // --- 5. H√ÄM QU·∫¢N L√ù PEERJS (WebRTC) ---
            
            function initializePeer(id) {
                if (peer) peer.destroy();
                try {
                    peer = new Peer(id, { debug: 2 });
                } catch (e) {
                    console.error("Kh√¥ng th·ªÉ kh·ªüi t·∫°o PeerJS. PeerJS c√≥ ƒë∆∞·ª£c t·∫£i kh√¥ng?", e);
                    return;
                }
                peer.on('open', (id) => console.log('PeerJS ƒë√£ s·∫µn s√†ng. ID c·ªßa t√¥i l√†:', id));
                peer.on('error', (err) => {
                    console.error('L·ªói PeerJS:', err);
                    if (err.type === 'peer-unavailable') {
                        alert('Kh√¥ng t√¨m th·∫•y m√£ gh√©p ƒë√¥i. Vui l√≤ng th·ª≠ l·∫°i.');
                        resetPairing();
                    }
                });
                peer.on('connection', (conn) => {
                    console.log('Ph√°t hi·ªán k·∫øt n·ªëi ƒë·∫øn:', conn.peer);
                    incomingConnection = conn;
                    if (incomingPeerId) incomingPeerId.textContent = conn.peer;
                    showModal(pairingModal);
                });
                peer.on('call', (call) => {
                    console.log('Nh·∫≠n ƒë∆∞·ª£c cu·ªôc g·ªçi video t·ª´:', call.peer);
                    if (!incomingConnection || incomingConnection.peer !== call.peer) {
                         console.log("Cu·ªôc g·ªçi ƒë·∫øn tr∆∞·ªõc khi x√°c nh·∫≠n. L∆∞u l·∫°i.");
                         incomingCall = call;
                         if (incomingPeerId) incomingPeerId.textContent = call.peer;
                         showModal(pairingModal);
                         return; 
                    }
                    openSelectSlotModal(call);
                });
            }
            
            function openSelectSlotModal(call) {
                incomingCall = call; 
                if (cameraSlotSelect) {
                    cameraSlotSelect.innerHTML = '<option value="new" class="text-black">-- Th√™m l√†m camera m·ªõi --</option>';
                    document.querySelectorAll('.camera-angle-wrapper').forEach(cam => {
                        const nameSpan = cam.querySelector('.camera-name');
                        if (nameSpan) {
                            const name = nameSpan.textContent;
                            const id = cam.id;
                            cameraSlotSelect.innerHTML += `<option value="${id}" class="text-black">Thay th·∫ø: ${name}</option>`;
                        }
                    });
                }
                hideModal(pairingModal);
                showModal(selectCameraSlotModal);
            }

            function generatePairCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function startPairingTimer() {
                let timeLeft = 300; 
                if (pairingTimer) pairingTimer.textContent = '05:00';
                if (pairingTimerInterval) clearInterval(pairingTimerInterval);
                pairingTimerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const seconds = (timeLeft % 60).toString().padStart(2, '0');
                    if (pairingTimer) pairingTimer.textContent = `${minutes}:${seconds}`;
                    if (timeLeft <= 0) resetPairing();
                }, 1000);
            }

            function resetPairing() {
                clearInterval(pairingTimerInterval);
                if (pairingDefaultView) pairingDefaultView.classList.remove('hidden');
                if (pairingCodeView) pairingCodeView.classList.add('hidden');
                if (peer) { peer.destroy(); peer = null; }
                currentPeerId = null;
            }

            if (btnGetPairCode) {
                btnGetPairCode.addEventListener('click', () => {
                    currentPeerId = generatePairCode();
                    if (pairCodeDisplay) pairCodeDisplay.textContent = currentPeerId;
                    if (pairingDefaultView) pairingDefaultView.classList.add('hidden');
                    if (pairingCodeView) pairingCodeView.classList.remove('hidden');
                    initializePeer(currentPeerId);
                    startPairingTimer();
                });
            }

            if (btnRejectPairing) {
                btnRejectPairing.addEventListener('click', () => {
                    if (incomingConnection) incomingConnection.close();
                    if (incomingCall) incomingCall.close();
                    incomingConnection = null;
                    incomingCall = null;
                    hideModal(pairingModal);
                });
            }
            
            if (btnAcceptPairing) {
                btnAcceptPairing.addEventListener('click', () => {
                    if (incomingConnection) incomingConnection.send('accepted');
                    if (incomingCall) openSelectSlotModal(incomingCall);
                    hideModal(pairingModal);
                });
            }

            if (btnCancelSelectSlot) {
                btnCancelSelectSlot.addEventListener('click', () => {
                    if (incomingCall) incomingCall.close();
                    incomingCall = null;
                    incomingConnection = null;
                    hideModal(selectCameraSlotModal);
                });
            }
            
            if (btnConfirmSelectSlot) {
                btnConfirmSelectSlot.addEventListener('click', () => {
                    const selectedSlotId = cameraSlotSelect.value;
                    if (!incomingCall) {
                        console.error("Kh√¥ng t√¨m th·∫•y cu·ªôc g·ªçi ƒë·∫øn!");
                        hideModal(selectCameraSlotModal);
                        return;
                    }
                    incomingCall.answer(); 
                    incomingCall.on('stream', (remoteStream) => {
                        console.log("ƒê√É NH·∫¨N STREAM VIDEO!", remoteStream);
                        let newOrUpdatedCam;
                        if (selectedSlotId === 'new') {
                            const newId = `cam-webrtc-${incomingCall.peer}`;
                            const newName = `Remote Cam (${incomingCall.peer.slice(0, 4)})`;
                            const newCam = createNewCameraElement(newId, newName, null, remoteStream);
                            if (cameraAngleContainer) cameraAngleContainer.appendChild(newCam);
                            newOrUpdatedCam = newCam;
                        } else {
                            const slotToReplace = document.getElementById(selectedSlotId);
                            if (slotToReplace) {
                                replaceCameraSlot(slotToReplace, remoteStream);
                                newOrUpdatedCam = slotToReplace;
                            }
                        }
                        if (newOrUpdatedCam) newOrUpdatedCam.click();
                    });
                    incomingCall.on('close', () => console.log("Stream video ƒë√£ ƒë√≥ng."));
                    incomingCall.on('error', (err) => console.error("L·ªói stream:", err));
                    hideModal(selectCameraSlotModal);
                    incomingCall = null;
                    incomingConnection = null;
                });
            }
            
            function replaceCameraSlot(slotElement, stream) {
                const img = slotElement.querySelector('.camera-angle-image');
                const video = slotElement.querySelector('.camera-angle-video');
                slotElement.videoStream = stream;
                if (video) video.srcObject = stream;
                slotElement.removeAttribute('data-src');
                if (video) video.classList.remove('hidden');
                if (img) img.classList.add('hidden');
                playVideoSafe(video);
            }
            
            // --- 6. H√ÄM QU·∫¢N L√ù AI (TensorFlow.js) ---
            
            async function loadModels() {
                try {
                    if (!window.tf || !window.blazeface || !window.cocoSsd) {
                        console.error("Thi·∫øu th∆∞ vi·ªán TensorFlow.js ho·∫∑c models.");
                        return;
                    }
                    console.log("ƒêang t·∫£i model AI...");
                    await tf.setBackend('webgl');
                    const p1 = blazeface.load();
                    const p2 = cocoSsd.load();
                    [faceModel, objectModel] = await Promise.all([p1, p2]);
                    console.log("ƒê√£ t·∫£i xong 2 model AI (BlazeFace & COCO-SSD).");
                    if (btnToggleDetection) btnToggleDetection.disabled = false;
                } catch (err) {
                    console.error("L·ªói t·∫£i model AI:", err);
                }
            }
            
            async function runDetection() {
                if (!isDetectionRunning || (!faceModel && !objectModel) || !detCtx) return;
                
                const sourceElement = mainVideoFeedVideo.classList.contains('hidden') ? null : mainVideoFeedVideo;
                
                if (!sourceElement || sourceElement.paused || sourceElement.ended || sourceElement.readyState < 2) {
                    detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    return;
                }

                const p1 = faceModel ? faceModel.estimateFaces(sourceElement, false) : Promise.resolve([]);
                const p2 = objectModel ? objectModel.detect(sourceElement) : Promise.resolve([]);
                const [facePredictions, objectPredictions] = await Promise.all([p1, p2]);

                detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                detCtx.font = '16px "Be Vietnam Pro", sans-serif'; 
                detCtx.textBaseline = 'top';

                const videoRatio = sourceElement.videoWidth / sourceElement.videoHeight;
                const canvasRatio = detectionCanvas.width / detectionCanvas.height;
                let scale = 1, offsetX = 0, offsetY = 0;

                // T√≠nh to√°n cho object-cover
                if (videoRatio > canvasRatio) { 
                     scale = detectionCanvas.height / sourceElement.videoHeight;
                     offsetX = (detectionCanvas.width - sourceElement.videoWidth * scale) / 2;
                     offsetY = 0;
                } else { 
                     scale = detectionCanvas.width / sourceElement.videoWidth;
                     offsetX = 0;
                     offsetY = (detectionCanvas.height - sourceElement.videoHeight * scale) / 2;
                }

                facePredictions.forEach(pred => {
                    const [startX, startY] = pred.topLeft;
                    const [endX, endY] = pred.bottomRight;
                    const [width, height] = [endX - startX, endY - startY];
                    const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                    detCtx.strokeStyle = '#32CD32'; 
                    detCtx.lineWidth = 2;
                    detCtx.strokeRect(x, y, w, h);
                    detCtx.fillStyle = '#32CD32';
                    detCtx.fillText('Face', x, y > 18 ? y - 18 : y + h + 4);
                });
                
                objectPredictions.forEach(pred => {
                    if (pred.class === 'sports ball') {
                        const [startX, startY, width, height] = pred.bbox;
                        const [x, y, w, h] = [startX * scale + offsetX, startY * scale + offsetY, width * scale, height * scale];
                        detCtx.strokeStyle = '#FFD700'; 
                        detCtx.lineWidth = 2;
                        detCtx.strokeRect(x, y, w, h);
                        detCtx.fillStyle = '#FFD700';
                        const label = `Ball (${Math.round(pred.score * 100)}%)`;
                        detCtx.fillText(label, x, y > 18 ? y - 18 : y + h + 4);
                    }
                });
            }

            if (btnToggleDetection) {
                btnToggleDetection.disabled = true; 
                btnToggleDetection.addEventListener('click', () => {
                    isDetectionRunning = !isDetectionRunning;
                    if (isDetectionRunning) {
                        btnToggleDetection.classList.add('danger');
                        btnToggleDetection.classList.remove('purple');
                        if (detectionInterval) clearInterval(detectionInterval);
                        detectionInterval = setInterval(runDetection, 100); 
                    } else {
                        btnToggleDetection.classList.remove('danger');
                        btnToggleDetection.classList.add('purple');
                        if (detectionInterval) clearInterval(detectionInterval);
                        if (detCtx) detCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height); 
                    }
                });
            }
            
            loadModels();
        }

        if (typeof Peer === 'undefined') {
            alert('L·ªói: Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán PeerJS. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ t·∫£i l·∫°i trang.');
        } else {
            main().catch(console.error);
        }

    </script>
</body>
</html>
